<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- åŸºç¡€SEOä¼˜åŒ– -->
    <title>FOCUS - æç®€ç›®æ ‡ç®¡ç† | åªåšæœ€é‡è¦çš„äº‹</title>
    <meta name="title" content="FOCUS - æç®€ç›®æ ‡ç®¡ç†å·¥å…· | ç›®æ ‡ç®¡ç† æ—¶é—´ç®¡ç† æç®€ä¸»ä¹‰">
    <meta name="description" content="FOCUSæ˜¯ä¸€æ¬¾æç®€ç›®æ ‡ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©ä½ æ‰¾åˆ°æœ€é‡è¦çš„äº‹ã€‚é€šè¿‡å‡æ³•æ€ç»´ï¼Œç­›é€‰å‡ºæ ¸å¿ƒç›®æ ‡ï¼Œä¸“æ³¨å®Œæˆã€‚æ”¯æŒç›®æ ‡ç®¡ç†ã€æ—¶é—´ç®¡ç†ã€æ¯æ—¥ä¸“æ³¨ã€æŒç»­æ‰“å¡ã€‚">
    <meta name="keywords" content="ç›®æ ‡ç®¡ç†,æ—¶é—´ç®¡ç†,æç®€ä¸»ä¹‰,ä¸“æ³¨,æ¯æ—¥è®¡åˆ’,ç›®æ ‡è¿½è¸ª,æ‰“å¡å·¥å…·,ä¸ªäººæˆé•¿,æ•ˆç‡å·¥å…·,å‡æ³•æ€ç»´">
    <meta name="author" content="FOCUS Team">
    <meta name="robots" content="index, follow">

    <!-- Open Graph ç¤¾äº¤åª’ä½“ä¼˜åŒ– -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sangzhexianxian.github.io/focus/">
    <meta property="og:title" content="FOCUS - æç®€ç›®æ ‡ç®¡ç† | åªåšæœ€é‡è¦çš„äº‹">
    <meta property="og:description" content="åœ¨ä¿¡æ¯è¿‡è½½çš„æ—¶ä»£ï¼Œå­¦ä¼šæ”¾å¼ƒæ¯”é€‰æ‹©æ›´é‡è¦ã€‚FOCUSå¸®ä½ ç”¨å‡æ³•æ€ç»´æ‰¾åˆ°çœŸæ­£é‡è¦çš„ç›®æ ‡ï¼Œæ¯å¤©ä¸“æ³¨ä¸€ä»¶äº‹ï¼ŒæŒç»­æˆé•¿ã€‚">
    <meta property="og:image" content="https://sangzhexianxian.github.io/focus/og-image.png">
    <meta property="og:site_name" content="FOCUS">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="FOCUS - æç®€ç›®æ ‡ç®¡ç† | åªåšæœ€é‡è¦çš„äº‹">
    <meta name="twitter:description" content="åœ¨ä¿¡æ¯è¿‡è½½çš„æ—¶ä»£ï¼Œå­¦ä¼šæ”¾å¼ƒæ¯”é€‰æ‹©æ›´é‡è¦ã€‚FOCUSå¸®ä½ ç”¨å‡æ³•æ€ç»´æ‰¾åˆ°çœŸæ­£é‡è¦çš„ç›®æ ‡ã€‚">
    <meta name="twitter:image" content="https://sangzhexianxian.github.io/focus/og-image.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://sangzhexianxian.github.io/focus/">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23667eea'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white' font-family='Arial'>ğŸ¯</text></svg>">

    <!-- ç»“æ„åŒ–æ•°æ® -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "FOCUS",
        "description": "æç®€ç›®æ ‡ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©ä½ æ‰¾åˆ°æœ€é‡è¦çš„äº‹",
        "url": "https://sangzhexianxian.github.io/focus/",
        "applicationCategory": "ProductivityApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "CNY"
        },
        "featureList": [
            "ç›®æ ‡ç®¡ç†",
            "æ—¶é—´ç®¡ç†",
            "æ¯æ—¥ä¸“æ³¨",
            "æŒç»­æ‰“å¡",
            "ç§¯åˆ†å¥–åŠ±"
        ],
        "creator": {
            "@type": "Organization",
            "name": "FOCUS Team"
        }
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {Uncaught SyntaxError: Identifier 'supabase' has already been declared (at index.html:1063:13)
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-avatar:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 180px;
            overflow: hidden;
            display: none;
            z-index: 100;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-item {
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-menu-item:hover {
            background: #f0f0f0;
        }

        .user-menu-item.danger {
            color: #dc3545;
            border-top: 1px solid #eee;
        }

        /* ç™»å½•å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .login-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-modal h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #667eea;
            text-align: center;
        }

        .login-modal p {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 15px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .toggle-auth {
            text-align: center;
            font-size: 14px;
            color: #667eea;
            cursor: pointer;
            transition: opacity 0.3s;
            margin-top: 15px;
        }

        .toggle-auth:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #999;
            font-size: 13px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        /* ç§¯åˆ†å¼¹çª— */
        .points-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .points-modal h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #667eea;
            text-align: center;
        }

        .points-modal h4 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        #dailyCheckInSection:hover {
            background: #c3e6cb !important;
            transform: scale(1.02);
            transition: all 0.2s;
        }

        .achievement-item {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            font-size: 13px;
        }

        .achievement-item .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .achievement-item .name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .achievement-item .desc {
            font-size: 11px;
            opacity: 0.9;
        }

        .achievement-item.locked {
            background: #e9ecef;
            color: #999;
        }

        .sync-status {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            gap: 5px;
            display: none;
        }

        .sync-status.show {
            display: flex;
        }

        .sync-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .sync-status.synced .dot {
            background: #28a745;
        }

        .sync-status.syncing .dot {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 12px 20px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .bottom-bar-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bottom-bar .sync-status {
            position: static;
            display: flex;
            color: #666;
            font-size: 13px;
        }

        .bottom-bar .sync-status.show {
            display: flex;
        }

        .bottom-actions {
            display: flex;
            gap: 8px;
        }

        .bottom-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background: #f8f9fa;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bottom-btn:hover {
            background: #e9ecef;
            border-color: #ccc;
        }

        .bottom-btn.danger {
            color: #dc3545;
            border-color: #ffcdd2;
            background: #fff5f5;
        }

        .bottom-btn.danger:hover {
            background: #ffcdd2;
        }

        /* ä¸ºåº•éƒ¨æ ç•™å‡ºç©ºé—´ */
        .container {
            margin-bottom: 60px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .demo-btn {
            background: rgba(255,255,255,0.25);
            color: white;
            border: 2px solid rgba(255,255,255,0.6);
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .demo-btn:hover {
            background: rgba(255,255,255,0.35);
            border-color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .content {
            padding: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            width: 0%;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
        }

        .step-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .tip-box {
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
            border-left: 4px solid #667eea;
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .input-area {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .goals-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 60px;
        }

        .goal-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 14px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: cardAppear 0.4s ease-out;
        }

        .goal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
        }

        .goal-card.removing {
            animation: cardDisappear 0.3s ease-out forwards;
        }

        .goal-card .icon {
            font-size: 16px;
        }

        .goal-card .remove-btn {
            opacity: 0;
            margin-left: 5px;
            cursor: pointer;
            transition: opacity 0.2s;
            color: #dc3545;
            font-weight: bold;
        }

        .goal-card:hover .remove-btn {
            opacity: 1;
        }

        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes cardDisappear {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }

        .empty-state .icon {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 16px 28px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon { color: #28a745; }
        .toast.success { border-left: 4px solid #28a745; }
        .toast.error .toast-icon { color: #dc3545; }
        .toast.error { border-left: 4px solid #dc3545; }
        .toast.info .toast-icon { color: #667eea; }
        .toast.info { border-left: 4px solid #667eea; }

        /* å¿«æ·æŒ‰é’®æç¤º */
        .quick-tip {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-top: 10px;
        }

        .goals-list {
            margin-bottom: 20px;
        }

        .goal-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .goal-item:hover {
            background: #e9ecef;
        }

        .goal-item:active {
            transform: scale(0.98);
            background: #e0e0e0;
        }

        .goal-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .goal-item.selected:active {
            background: #e8edff;
        }

        .goal-item .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .goal-item.selected .checkbox {
            background: #667eea;
            border-color: #667eea;
        }

        .goal-item.selected .checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }

        .goal-item .text {
            flex: 1;
            font-size: 14px;
        }

        .weight-section {
            margin-bottom: 20px;
        }

        .weight-item {
            margin-bottom: 15px;
        }

        .weight-label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }

        .weight-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .weight-slider {
            width: 100%;
            margin-top: 8px;
        }

        .weight-total {
            text-align: center;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .weight-total.valid {
            background: #d4edda;
            color: #155724;
        }

        .weight-total.invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .card-preview {
            text-align: center;
            margin-bottom: 20px;
        }

        .card-preview canvas {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .download-btn {
            background: #28a745;
        }

        .download-btn:hover {
            background: #218838;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .restart-btn {
            background: #6c757d;
            margin-left: 10px;
        }

        .restart-btn:hover {
            background: #5a6268;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        /* æŒ‘æˆ˜æŒ‰é’®æ ·å¼ */
        .challenge-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .challenge-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #764ba2 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .selection-count {
            text-align: center;
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
        }

        .share-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .share-section h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .share-section p {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }

        .copy-link-btn {
            background: #6c757d;
            font-size: 14px;
            padding: 10px 20px;
        }

        .copy-link-btn:hover {
            background: #5a6268;
        }

        .copy-success {
            color: #28a745;
            font-size: 13px;
            margin-left: 10px;
        }

        .daily-checkin {
            text-align: center;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            margin-top: 20px;
        }

        .daily-checkin h4 {
            margin-bottom: 8px;
            color: #155724;
        }

        .daily-checkin p {
            font-size: 13px;
            color: #155724;
            margin-bottom: 10px;
        }

        .streak-count {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }

        @media (max-width: 600px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                min-height: 100vh;
                box-shadow: none;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 28px !important;
                letter-spacing: 1px !important;
            }

            .header p {
                font-size: 14px !important;
            }

            .user-info {
                top: 10px;
                right: 10px;
                gap: 6px;
                flex-wrap: wrap;
                justify-content: flex-end;
                max-width: 70%;
            }

            .demo-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            #loggedInActions {
                gap: 4px !important;
            }

            #loggedInActions .demo-btn {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }

            .login-btn {
                font-size: 13px;
                padding: 8px 16px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .content {
                padding: 20px 15px;
            }

            .step-title {
                font-size: 18px;
            }

            .step-desc {
                font-size: 13px;
            }

            .tip-box {
                font-size: 13px;
                padding: 12px 14px;
            }

            textarea {
                font-size: 15px;
                padding: 12px;
            }

            .goal-card {
                font-size: 13px;
                padding: 8px 16px;
            }

            .btn {
                width: 100%;
                font-size: 15px;
                padding: 14px;
            }

            .card-preview canvas {
                max-width: 100%;
                height: auto !important;
            }

            .daily-checkin {
                padding: 12px;
            }

            .streak-count {
                font-size: 20px;
            }

            /* ä¼˜åŒ–é€‰æ‹©åˆ—è¡¨åœ¨ç§»åŠ¨ç«¯çš„è§¦æ‘¸ä½“éªŒ */
            .goal-item {
                padding: 16px 12px;
                margin-bottom: 12px;
                min-height: 56px;
            }

            .goal-item .checkbox {
                width: 28px;
                height: 28px;
                margin-right: 14px;
            }

            .goal-item .text {
                font-size: 15px;
                line-height: 1.5;
            }

            .selection-count {
                font-size: 16px;
                padding: 10px;
                background: rgba(102, 126, 234, 0.1);
                border-radius: 8px;
                margin-bottom: 15px;
            }

            /* æƒé‡æ»‘å—åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .weight-slider {
                height: 40px;
                -webkit-appearance: none;
                appearance: none;
                background: #e0e0e0;
                border-radius: 20px;
                outline: none;
            }

            .weight-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            }

            .weight-slider::-moz-range-thumb {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                cursor: pointer;
                border: none;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            }

            .weight-item {
                padding: 15px;
                background: #f8f9fa;
                border-radius: 12px;
                margin-bottom: 15px;
            }

            .weight-label {
                font-size: 15px;
                font-weight: 500;
                margin-bottom: 12px;
            }

            /* é‡æ–°é€‰æ‹©æŒ‰é’®åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .btn.restart-btn {
                font-size: 14px;
                padding: 12px 20px;
                flex: 1;
                min-width: 140px;
            }

            /* ç™»å½•å¼¹çª—åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .login-modal {
                padding: 30px 20px;
                width: 95%;
            }

            .login-modal h2 {
                font-size: 22px;
            }

            .form-group input {
                padding: 14px;
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }

            .login-btn {
                padding: 16px;
                font-size: 16px;
            }

            /* ç”¨æˆ·èœå•åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .user-menu {
                right: 10px;
                min-width: 160px;
            }

            .user-menu-item {
                padding: 14px 16px;
                font-size: 15px;
            }

            /* ç›®æ ‡å¡ç‰‡åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .goals-cards {
                gap: 8px;
            }

            .goal-card {
                font-size: 14px;
                padding: 10px 16px;
                border-radius: 20px;
            }

            /* Toastæç¤ºåœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .toast {
                padding: 14px 20px;
                font-size: 14px;
                max-width: 90%;
            }

            /* åˆ†äº«åŒºåŸŸåœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .share-section {
                padding: 15px;
            }

            .share-section h4 {
                font-size: 16px;
            }

            /* æ¯æ—¥æ‰“å¡åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .daily-checkin {
                padding: 20px 15px;
            }

            .daily-checkin h4 {
                font-size: 16px;
            }

            #checkinBtn {
                width: auto;
                min-width: 120px;
            }

            /* åº•éƒ¨æ åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ– */
            .bottom-bar {
                padding: 10px 15px;
            }

            .bottom-bar-content {
                gap: 10px;
            }

            .bottom-bar .sync-status {
                font-size: 11px;
                white-space: nowrap;
            }

            .bottom-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .container {
                margin-bottom: 55px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 42px; font-weight: 900; letter-spacing: 2px; text-shadow: 0 4px 20px rgba(0,0,0,0.3);">FOCUS Â· åªåšæœ€é‡è¦çš„äº‹</h1>
            <p style="font-size: 16px; opacity: 0.95; font-weight: 500; letter-spacing: 1px; margin-top: 8px;">å­¦ä¼šæ”¾å¼ƒï¼Œæ¯”é€‰æ‹©æ›´é‡è¦</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Step 1: è¾“å…¥æ‰€æœ‰ç›®æ ‡ -->
            <div class="step active" id="step1">
                <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="step-title" style="margin-bottom: 0;">ç¬¬ä¸€æ­¥ï¼šå€’å‡ºæ‰€æœ‰ç›®æ ‡</div>
                    <button class="demo-btn" onclick="startDemo()" style="padding: 8px 16px; font-size: 13px;">â–¶ çœ‹æ¼”ç¤º</button>
                </div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šä¸è¦ç­›é€‰ï¼Œä¸è¦æ’åºï¼ŒæŠŠè„‘å­é‡Œæ‰€æœ‰æƒ³åšçš„äº‹æƒ…éƒ½å†™ä¸‹æ¥ã€‚æ¯æŒ‰ä¸€æ¬¡å›è½¦ï¼Œå°±ä¼šå˜æˆä¸€å¼ å¡ç‰‡ã€‚å†™å®Œç‚¹å‡»"æˆ‘å†™å®Œäº†"ã€‚
                </div>
                <div class="step-desc" id="step1Desc">
                    æŠŠä½ 2026å¹´æƒ³åšçš„æ‰€æœ‰äº‹æƒ…éƒ½å†™ä¸‹æ¥ï¼Œä¸é™æ•°é‡ï¼Œä¸ç”¨æ’åºã€‚è®©å¤§è„‘æ¸…ç©ºã€‚
                </div>
                <div class="input-area">
                    <textarea id="allGoals" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„ç›®æ ‡ï¼ŒæŒ‰å›è½¦é”®ç¡®è®¤..."></textarea>
                </div>
                <div class="goals-cards" id="goalsCards">
                    <div class="empty-state">
                        <span class="icon">âœ¨</span>
                        åœ¨ä¸Šé¢è¾“å…¥æ¡†ä¸­å†™ä¸‹ä½ çš„ç¬¬ä¸€ä¸ªç›®æ ‡
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 20px; color: #999; font-size: 13px;">
                    å·²è®°å½• <span id="goalCount" style="color: #667eea; font-weight: bold;">0</span> ä¸ªç›®æ ‡
                </div>
                <div style="text-align: center;">
                    <button class="btn" onclick="goToStep2()">æˆ‘å†™å®Œäº†ï¼Œä¸‹ä¸€æ­¥</button>
                </div>

                <!-- æŒ‘æˆ˜æ¨¡å¼å…¥å£ -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <span style="font-size: 14px; color: #999;">ğŸ¯ æƒ³æŒ‘æˆ˜ä¸åŒä¸“æ³¨æ¨¡å¼ï¼Ÿ</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <button class="challenge-btn" onclick="openChallenge('daily1')">ğŸ“… ä¸€å¤©1ä»¶äº‹</button>
                        <button class="challenge-btn" onclick="openChallenge('daily3')">ğŸ“… ä¸€å¤©3ä»¶äº‹</button>
                        <button class="challenge-btn" onclick="openChallenge('weekly3')">ğŸ“† ä¸€å‘¨3ä»¶äº‹</button>
                        <button class="challenge-btn" onclick="openChallenge('monthly3')">ğŸ—“ï¸ ä¸€æœˆ3ä»¶äº‹</button>
                        <button class="challenge-btn" onclick="openChallenge('yearly3')">ğŸ¯ 2026å¹´3ä»¶äº‹</button>
                        <button class="challenge-btn" onclick="openChallenge('oneLife')">â­ ä¸€ç”Ÿ1ä»¶äº‹</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: é€‰å‡º5ä¸ª -->
            <div class="step" id="step2">
                <div class="step-title">ç¬¬äºŒæ­¥ï¼šé€‰å‡ºæœ€é‡è¦çš„5ä¸ª</div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šé—®è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœ2026å¹´åªèƒ½å®Œæˆ5ä»¶äº‹ï¼Œæˆ‘ä¼šé€‰å“ª5ä¸ªï¼Ÿ
                </div>
                <div class="step-desc">
                    ä»ä½ åˆšæ‰åˆ—å‡ºçš„ç›®æ ‡ä¸­ï¼Œé€‰å‡º5ä¸ª"çœ‹èµ·æ¥å¾ˆé‡è¦"çš„ã€‚è¿™æ˜¯ç¬¬ä¸€è½®ç­›é€‰ã€‚
                </div>
                <div class="selection-count" id="step2Count">å·²é€‰æ‹© 0/5</div>
                <div class="goals-list" id="step2List"></div>
                <div class="error-message" id="step2Error"></div>
                <button class="btn" onclick="goToStep3()">ä¸‹ä¸€æ­¥</button>
            </div>

            <!-- Step 3: é€‰å‡º3ä¸ª -->
            <div class="step" id="step3">
                <div class="step-title">ç¬¬ä¸‰æ­¥ï¼šæœ€ç»ˆé€‰å‡º3ä¸ª</div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šè¿™å¯èƒ½æ˜¯æœ€ç—›è‹¦çš„ä¸€æ­¥ã€‚é—®è‡ªå·±ï¼šå“ª3ä¸ªç›®æ ‡å®ç°åï¼Œä¼šè®©2026å¹´æ— æ†¾ï¼Ÿ
                </div>
                <div class="step-desc">
                    ä»è¿™5ä¸ªç›®æ ‡ä¸­ï¼Œåªä¿ç•™3ä¸ªã€‚è¿™æ˜¯æ®‹é…·ä½†å¿…è¦çš„ä¸€æ­¥ï¼Œå…¶ä»–çš„åªèƒ½æ”¾å¼ƒã€‚
                </div>
                <div class="selection-count" id="step3Count">å·²é€‰æ‹© 0/3</div>
                <div class="goals-list" id="step3List"></div>
                <div class="error-message" id="step3Error"></div>
                <button class="btn" onclick="goToStep4()">ä¸‹ä¸€æ­¥</button>
            </div>

            <!-- Step 4: åˆ†é…æƒé‡ -->
            <div class="step" id="step4">
                <div class="step-title">ç¬¬å››æ­¥ï¼šåˆ†é…æƒé‡</div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šæƒé‡ä»£è¡¨ä½ çš„ç²¾åŠ›åˆ†é…ã€‚50%çš„ç›®æ ‡è¦æŠ•å…¥ä¸€åŠçš„æ—¶é—´å’Œæ³¨æ„åŠ›ã€‚
                </div>
                <div class="step-desc">
                    ç»™è¿™3ä¸ªç›®æ ‡åˆ†é…æƒé‡ï¼Œæ€»å’Œå¿…é¡»æ˜¯100%ã€‚
                </div>
                <div class="weight-section" id="weightSection"></div>
                <div class="weight-total" id="weightTotal">
                    å½“å‰æ€»å’Œï¼š0%
                </div>
                <div class="error-message" id="step4Error"></div>
                <button class="btn" onclick="generateCard()">ç”Ÿæˆä¸“æ³¨å¡</button>
            </div>

            <!-- Step 5: ç”Ÿæˆä¸“æ³¨å¡ -->
            <div class="step" id="step5">
                <div class="step-title">ä½ çš„2026ä¸“æ³¨å¡</div>
                <div class="step-desc">
                    æŠŠè¿™å¼ å¡ä¿å­˜ä¸ºæ‰‹æœºå£çº¸ï¼Œæ¯å¤©æé†’è‡ªå·±ï¼šåªåšè¿™ä¸‰ä»¶äº‹ã€‚
                </div>
                <div class="card-preview">
                    <canvas id="focusCard"></canvas>
                </div>
                <div style="text-align: center;">
                    <button class="btn download-btn" onclick="downloadCard()">ä¸‹è½½ä¸“æ³¨å¡</button>
                </div>

                <div class="daily-checkin" id="dailyCheckin">
                    <h4>ğŸ”¥ å·²è¿ç»­ä¸“æ³¨ <span class="streak-count" id="streakCount">0</span> å¤©</h4>
                    <p>æ¯å¤©å›æ¥æ‰“å¡ï¼Œä¿æŒä¸“æ³¨æƒ¯æ€§</p>
                    <button class="btn" onclick="dailyCheckin()" id="checkinBtn">ä»Šæ—¥æ‰“å¡</button>
                </div>

                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; border: 1px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">ğŸ’° æˆ‘çš„ç§¯åˆ†</h4>
                    <div style="display: flex; gap: 20px; justify-content: center; align-items: center; flex-wrap: wrap;">
                        <div>
                            <span style="font-size: 24px; font-weight: bold; color: #f39c12;" id="step5TotalPoints">0</span>
                            <span style="font-size: 13px; color: #856404;">æ€»ç§¯åˆ†</span>
                        </div>
                        <div>
                            <span id="step5UserLevel" style="font-weight: bold;">LV1 ä¸“æ³¨æ–°æ‰‹</span>
                            <span style="font-size: 13px; color: #856404;">ç­‰çº§</span>
                        </div>
                        <div>
                            <span style="font-weight: bold; color: #e74c3c;" id="step5Streak">è¿ç»­0å¤©</span>
                            <span style="font-size: 13px; color: #856404;">ç­¾åˆ°</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 13px; color: #666;">
                    <p style="margin-bottom: 8px;">ğŸ’¡ å°æç¤ºï¼šæŠŠè¿™å¼ ä¸“æ³¨å¡è®¾ä¸ºæ‰‹æœºå£çº¸</p>
                    <p>æ¯å¤©çå¼€çœ¼å°±èƒ½çœ‹åˆ°ï¼Œæ—¶åˆ»æé†’è‡ªå·±</p>
                </div>

                <div class="share-section">
                    <h4>ğŸ“¤ åˆ†äº«ç»™ä½ çš„æœ‹å‹</h4>
                    <p>è®©æ›´å¤šäººç”¨å‡æ³•æ€ç»´è§„åˆ’2026</p>
                    <button class="btn copy-link-btn" onclick="copyShareLink()">å¤åˆ¶é“¾æ¥</button>
                    <span class="copy-success" id="copySuccess" style="display: none;">âœ“ å·²å¤åˆ¶</span>
                    <p style="margin-top: 10px; font-size: 12px; color: #28a745;">åˆ†äº«è·å¾— +15 ç§¯åˆ†</p>
                </div>

                <div style="text-align: center; margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn restart-btn" onclick="goBackToSelect()">ğŸ”„ é‡æ–°é€‰æ‹©ç›®æ ‡</button>
                    <button class="btn restart-btn" onclick="restart()" style="background: #dc3545;">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="bottom-bar" id="bottomBar">
        <div class="bottom-bar-content">
            <div class="sync-status" id="syncStatus">
                <span class="dot"></span>
                <span id="syncText">æœ¬åœ°æ¨¡å¼</span>
            </div>
            <div class="bottom-actions" style="display: flex; gap: 8px; align-items: center;">
                <button class="bottom-btn" onclick="showPointsModal()" style="color: #f39c12; border-color: #f39c12;">
                    <span style="margin-right: 4px;">ğŸ’°</span>
                    <span id="totalPoints">0</span>åˆ†
                </button>
                <button class="bottom-btn" id="bottomLoginBtn" onclick="showLoginModal()">ğŸ‘¤ ç™»å½•</button>
                <div id="bottomLoggedInActions" style="display: none; gap: 8px;">
                    <button class="bottom-btn" onclick="syncToCloud()">â˜ï¸ åŒæ­¥</button>
                    <button class="bottom-btn" onclick="viewProfile()">ğŸ‘¤ èµ„æ–™</button>
                    <button class="bottom-btn danger" onclick="logout()">ğŸšª é€€å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·èœå•ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰ -->
    <div class="user-menu" id="userMenu">
        <div class="user-menu-item" onclick="syncToCloud()">
            <span>â˜ï¸</span>
            <span id="syncMenuItem">ç«‹å³åŒæ­¥</span>
        </div>
        <div class="user-menu-item" onclick="viewProfile()">
            <span>ğŸ‘¤</span>
            <span>ä¸ªäººèµ„æ–™</span>
        </div>
        <div class="user-menu-item danger" onclick="logout()">
            <span>ğŸšª</span>
            <span>é€€å‡ºç™»å½•</span>
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div class="modal-overlay" id="loginModal">
        <div class="login-modal" style="position: relative;">
            <button class="close-modal" onclick="hideLoginModal()">Ã—</button>

            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm">
                <h2>æ¬¢è¿å›æ¥</h2>
                <p>ç™»å½•åè‡ªåŠ¨åŒæ­¥ä½ çš„ä¸“æ³¨ç›®æ ‡</p>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="login-btn" onclick="handleLogin()" id="loginSubmitBtn">ç™»å½•</button>

                <div class="auth-divider">æˆ–</div>

                <button class="login-btn" style="background: #24292e;" onclick="handleGuestLogin()">
                    <span style="font-size: 16px;">ğŸ‘¤</span>
                    <span style="margin-left: 8px;">æ¸¸å®¢æ¨¡å¼ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰</span>
                </button>

                <div class="toggle-auth" onclick="showRegisterForm()">æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</div>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #999;">
                    <a href="#" onclick="showForgotPassword()" style="color: #667eea;">å¿˜è®°å¯†ç ï¼Ÿ</a>
                </div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerForm" style="display: none;">
                <h2>åˆ›å»ºè´¦å·</h2>
                <p>æ³¨å†Œåè‡ªåŠ¨äº‘ç«¯ä¿å­˜ä½ çš„ä¸“æ³¨ç›®æ ‡</p>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰</label>
                    <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" id="registerConfirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-start; gap: 8px;">
                    <input type="checkbox" id="agreeTerms" style="margin-top: 3px;">
                    <label for="agreeTerms" style="font-size: 13px; color: #666; cursor: pointer;">
                        æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#" style="color: #667eea; text-decoration: none;" onclick="event.preventDefault(); alert('æœåŠ¡æ¡æ¬¾å†…å®¹...');">æœåŠ¡æ¡æ¬¾</a>
                    </label>
                </div>
                <button class="login-btn" onclick="handleRegister()" id="registerSubmitBtn">æ³¨å†Œ</button>
                <div class="toggle-auth" onclick="showLoginForm()">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</div>
            </div>
        </div>
    </div>

    <!-- ç§¯åˆ†å¼¹çª— -->
    <div class="modal-overlay" id="pointsModal">
        <div class="points-modal">
            <button class="close-modal" onclick="hidePointsModal()">Ã—</button>

            <h2>ğŸ’° æˆ‘çš„ç§¯åˆ†</h2>

            <!-- ç§¯åˆ†æ¦‚è§ˆ -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 25px; flex-wrap: wrap;">
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white; flex: 1; min-width: 100px;">
                    <div style="font-size: 28px; font-weight: bold;" id="modalTotalPoints">0</div>
                    <div style="font-size: 12px; opacity: 0.9;">æ€»ç§¯åˆ†</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f39c12; border-radius: 10px; color: white; flex: 1; min-width: 100px;">
                    <div id="modalUserLevel" style="font-weight: bold;">LV1 ä¸“æ³¨æ–°æ‰‹</div>
                    <div style="font-size: 12px; opacity: 0.9;">å½“å‰ç­‰çº§</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #e74c3c; border-radius: 10px; color: white; flex: 1; min-width: 100px;">
                    <div style="font-size: 28px; font-weight: bold;" id="modalStreak">0</div>
                    <div style="font-size: 12px; opacity: 0.9;">è¿ç»­å¤©æ•°</div>
                </div>
            </div>

            <!-- ç­‰çº§è¿›åº¦ -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666; margin-bottom: 5px;">
                    <span>ç­‰çº§è¿›åº¦</span>
                    <span id="levelProgress">0 / 100</span>
                </div>
                <div style="height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div id="levelProgressBar" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>

            <!-- æ¯æ—¥ç­¾åˆ° -->
            <div id="dailyCheckInSection" style="text-align: center; padding: 15px; background: #d4edda; border-radius: 8px; margin-bottom: 20px; cursor: pointer;" onclick="dailyCheckIn()">
                <h4 style="margin-bottom: 8px; color: #155724;">ğŸ“… æ¯æ—¥ç­¾åˆ°</h4>
                <p style="margin: 0; font-size: 13px; color: #155724;">ç­¾åˆ°è·å¾— +10 ç§¯åˆ†ï¼Œè¿ç»­ç­¾åˆ°æœ‰é¢å¤–å¥–åŠ±</p>
            </div>

            <!-- ç§¯åˆ†è·å–æ–¹å¼ -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: #333;">ğŸ¯ ç§¯åˆ†è·å–</h4>
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px;">
                        <span>æ¯æ—¥ç­¾åˆ°</span>
                        <span style="color: #28a745; font-weight: bold;">+10</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px;">
                        <span>å®Œæˆä¸“æ³¨å¡</span>
                        <span style="color: #28a745; font-weight: bold;">+50</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px;">
                        <span>åˆ†äº«ä¸“æ³¨å¡</span>
                        <span style="color: #28a745; font-weight: bold;">+15</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px;">
                        <span>è¿ç»­7å¤©</span>
                        <span style="color: #f39c12; font-weight: bold;">+20</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px;">
                        <span>è¿ç»­30å¤©</span>
                        <span style="color: #e74c3c; font-weight: bold;">+30</span>
                    </div>
                </div>
            </div>

            <!-- æˆå°±å±•ç¤º -->
            <div id="achievementsSection">
                <h4 style="margin-bottom: 10px; color: #333;">ğŸ† æˆ‘çš„æˆå°±</h4>
                <div id="achievementsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                    <!-- æˆå°±ä¼šåŠ¨æ€åŠ è½½ -->
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; color: #999; font-size: 13px; grid-column: 1 / -1;">
                        æš‚æ— æˆå°±
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">âœ“</span>
        <span id="toastMessage">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://klywwizwconvwjifzrcw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_65tNpTMzDgY8PFEQxIS-Eg_0tXESrkV';

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        let supabaseClient = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.log('Supabase åº“æœªåŠ è½½');
            }
        } catch (e) {
            console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', e);
        }

        // æ•°æ®å­˜å‚¨
        let allGoalsList = [];
        let top5Goals = [];
        let top3Goals = [];
        let weights = [0, 0, 0];
        let isDemoRunning = false;
        let audioContext = null;
        let currentUser = null;
        let isCloudMode = false;
        let currentChallengeMode = 'yearly3'; // é»˜è®¤æ¨¡å¼

        // ===== ç§¯åˆ†ç³»ç»Ÿ =====
        let userPoints = {
            total: 0,
            level: 1,
            checkInStreak: 0,
            lastCheckInDate: null,
            achievements: [],
            history: []
        };

        // ç­‰çº§é…ç½®
        const levelConfig = {
            1: { name: 'ä¸“æ³¨æ–°æ‰‹', points: 0, color: '#95a5a6' },
            2: { name: 'ä¸“æ³¨è¾¾äºº', points: 100, color: '#3498db' },
            3: { name: 'ä¸“æ³¨é«˜æ‰‹', points: 500, color: '#9b59b6' },
            4: { name: 'ä¸“æ³¨å¤§å¸ˆ', points: 1000, color: '#f39c12' },
            5: { name: 'ä¸“æ³¨ç‹è€…', points: 3000, color: '#e74c3c' },
            6: { name: 'ä¸“æ³¨ä¼ å¥‡', points: 10000, color: '#f1c40f' }
        };

        // æˆå°±é…ç½®
        const achievementConfig = {
            firstCard: { name: 'åˆå…¥ä¸“æ³¨', desc: 'å®Œæˆç¬¬1å¼ ä¸“æ³¨å¡', points: 20, icon: 'ğŸŒŸ' },
            dailyCheckIn: { name: 'æ¯æ—¥æ‰“å¡', desc: 'è¿ç»­ç­¾åˆ°7å¤©', points: 50, icon: 'ğŸ“…' },
            monthStreak: { name: 'ä¸€æœˆåšæŒ', desc: 'è¿ç»­å®Œæˆ30å¤©', points: 200, icon: 'ğŸ”¥' },
            hundredDays: { name: 'ç™¾æ—¥ç­‘åŸº', desc: 'è¿ç»­å®Œæˆ100å¤©', points: 500, icon: 'ğŸ’' },
            yearAchievement: { name: 'ä¸€å¹´æˆå°±', desc: 'è¿ç»­å®Œæˆ365å¤©', points: 1000, icon: 'ğŸ†' },
            shareMaster: { name: 'åˆ†äº«è¾¾äºº', desc: 'åˆ†äº«ä¸“æ³¨å¡10æ¬¡', points: 100, icon: 'ğŸ“¤' },
            goalsCompleted: { name: 'ç›®æ ‡è¾¾æˆ', desc: 'å®Œæˆæ‰€æœ‰è®¾å®šçš„ç›®æ ‡', points: 100, icon: 'âœ…' }
        };

        // è·å–ç§¯åˆ†
        function addPoints(points, reason) {
            userPoints.total += points;
            userPoints.history.unshift({
                points: points,
                reason: reason,
                date: new Date().toISOString()
            });

            // æ›´æ–°ç­‰çº§
            updateLevel();

            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('focus2026_points', JSON.stringify(userPoints));

            // æ˜¾ç¤ºæç¤º
            if (points > 0) {
                showToast(`+${points}åˆ† | ${reason}`, 'success');
            }

            // åŒæ­¥åˆ°äº‘ç«¯
            if (isCloudMode && currentUser) {
                syncPointsToCloud();
            }
        }

        // æ¶ˆè€—ç§¯åˆ†
        function usePoints(points, reason) {
            if (userPoints.total < points) {
                showToast('ç§¯åˆ†ä¸è¶³', 'error');
                return false;
            }

            userPoints.total -= points;
            userPoints.history.unshift({
                points: -points,
                reason: reason,
                date: new Date().toISOString()
            });

            // æ›´æ–°ç­‰çº§
            updateLevel();

            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('focus2026_points', JSON.stringify(userPoints));

            // æ˜¾ç¤ºæç¤º
            showToast(`-${points}åˆ† | ${reason}`, 'info');

            // åŒæ­¥åˆ°äº‘ç«¯
            if (isCloudMode && currentUser) {
                syncPointsToCloud();
            }

            return true;
        }

        // æ›´æ–°ç­‰çº§
        function updateLevel() {
            let newLevel = 1;
            for (let level = 6; level >= 1; level--) {
                if (userPoints.total >= levelConfig[level].points) {
                    newLevel = level;
                    break;
                }
            }

            // å¦‚æœç­‰çº§æå‡ï¼Œæ˜¾ç¤ºé€šçŸ¥
            if (newLevel > userPoints.level) {
                userPoints.level = newLevel;
                showToast(`æ­å–œå‡çº§ï¼è·å¾—ã€Œ${levelConfig[newLevel].name}ã€ç§°å·`, 'success');
            }
        }

        // æ¯æ—¥ç­¾åˆ°
        function dailyCheckIn() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (userPoints.lastCheckInDate === today) {
                showToast('ä»Šæ—¥å·²ç­¾åˆ°', 'info');
                return;
            }

            // è®¡ç®—è¿ç»­ç­¾åˆ°
            if (userPoints.lastCheckInDate === yesterday) {
                userPoints.checkInStreak++;
            } else {
                userPoints.checkInStreak = 1;
            }

            userPoints.lastCheckInDate = today;

            // åŸºç¡€ç­¾åˆ°ç§¯åˆ†
            let points = 10;

            // è¿ç»­ç­¾åˆ°å¥–åŠ±
            if (userPoints.checkInStreak >= 100) {
                points += 30;
                addAchievement('hundredDays');
            } else if (userPoints.checkInStreak >= 30) {
                points += 20;
                addAchievement('monthStreak');
            } else if (userPoints.checkInStreak >= 7) {
                points += 10;
                addAchievement('dailyCheckIn');
            }

            addPoints(points, 'æ¯æ—¥ç­¾åˆ°');
        }

        // æ·»åŠ æˆå°±
        function addAchievement(achievementId) {
            if (!userPoints.achievements.includes(achievementId)) {
                userPoints.achievements.push(achievementId);
                const achievement = achievementConfig[achievementId];
                addPoints(achievement.points, `è§£é”æˆå°±ï¼š${achievement.name}`);
                showToast(`ğŸ† è§£é”æˆå°±ï¼š${achievement.name}`, 'success');
            }
        }

        // åŒæ­¥ç§¯åˆ†åˆ°äº‘ç«¯
        async function syncPointsToCloud() {
            if (!supabaseClient || !currentUser) return;

            try {
                const { data, error } = await supabaseClient
                    .from('user_points')
                    .upsert({
                        user_id: currentUser.id,
                        total_points: userPoints.total,
                        level: userPoints.level,
                        check_in_streak: userPoints.checkInStreak,
                        last_check_in_date: userPoints.lastCheckInDate,
                        achievements: userPoints.achievements,
                        points_history: userPoints.history.slice(0, 100) // åªä¿ç•™æœ€è¿‘100æ¡
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) throw error;

                // æ›´æ–°æ’è¡Œæ¦œ
                await updateLeaderboard();
            } catch (error) {
                console.error('åŒæ­¥ç§¯åˆ†å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ’è¡Œæ¦œ
        async function updateLeaderboard() {
            if (!supabaseClient || !currentUser) return;

            try {
                const { data, error } = await supabaseClient
                    .from('points_leaderboard')
                    .upsert({
                        user_id: currentUser.id,
                        total_points: userPoints.total,
                        level: userPoints.level,
                        check_in_streak: userPoints.checkInStreak
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) throw error;
            } catch (error) {
                console.error('æ›´æ–°æ’è¡Œæ¦œå¤±è´¥:', error);
            }
        }

        // ä»æœ¬åœ°åŠ è½½ç§¯åˆ†
        function loadPointsFromLocal() {
            const pointsData = localStorage.getItem('focus2026_points');
            if (pointsData) {
                userPoints = JSON.parse(pointsData);
                updatePointsDisplay();
            }
        }

        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        function updatePointsDisplay() {
            const pointsEl = document.getElementById('totalPoints');
            const levelEl = document.getElementById('userLevel');
            const streakEl = document.getElementById('checkInStreak');

            // åº•éƒ¨æ æ˜¾ç¤º
            if (pointsEl) pointsEl.textContent = userPoints.total;

            // Step 5 æ˜¾ç¤º
            const step5PointsEl = document.getElementById('step5TotalPoints');
            const step5LevelEl = document.getElementById('step5UserLevel');
            const step5StreakEl = document.getElementById('step5Streak');

            if (step5PointsEl) step5PointsEl.textContent = userPoints.total;
            if (step5LevelEl) {
                const levelInfo = levelConfig[userPoints.level];
                step5LevelEl.textContent = `LV${userPoints.level} ${levelInfo.name}`;
                step5LevelEl.style.color = levelInfo.color;
            }
            if (step5StreakEl) step5StreakEl.textContent = `è¿ç»­${userPoints.checkInStreak}å¤©`;

            if (levelEl) {
                const levelInfo = levelConfig[userPoints.level];
                levelEl.textContent = `LV${userPoints.level} ${levelInfo.name}`;
                levelEl.style.color = levelInfo.color;
            }
            if (streakEl) streakEl.textContent = `è¿ç»­${userPoints.checkInStreak}å¤©`;
        }

        // ===== å…¨å±€å‡½æ•°å®šä¹‰ï¼ˆç¡®ä¿åœ¨æ‰€æœ‰ä½ç½®éƒ½å¯ç”¨ï¼‰=====

        // å¤„ç†è¾“å…¥æ¡†æŒ‰é”®
        function handleInputKeydown(event) {
            console.log('é”®ç›˜äº‹ä»¶è§¦å‘:', event.key, event.code, event.keyCode);
            if (event.key === 'Enter' && !event.shiftKey) {
                console.log('æ£€æµ‹åˆ°Enteré”®ï¼Œå‡†å¤‡æ·»åŠ ç›®æ ‡');
                event.preventDefault();
                const textarea = document.getElementById('allGoals');
                const text = textarea.value.trim();

                console.log('è¾“å…¥å†…å®¹:', text);
                if (text.length > 0) {
                    console.log('è°ƒç”¨ addGoalCard');
                    addGoalCard(text);
                    textarea.value = '';
                    textarea.focus();
                }
            }
        }

        // ===== éŸ³æ•ˆç³»ç»Ÿ =====
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // æ‰“å­—éŸ³æ•ˆ - æ¸…è„†çš„æ°”æ³¡å£°
        function playTypingSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800 + Math.random() * 200, audioContext.currentTime);
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // å¡ç‰‡å‡ºç°éŸ³æ•ˆ - æŸ”å’Œçš„ç¡®è®¤å£°
        function playCardSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.exponentialRampToValueAtTime(783.99, audioContext.currentTime + 0.1); // G5
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // é‡Šæ”¾éŸ³æ•ˆ - èˆ’ç¼“çš„å’Œå¼¦
        function playReleaseSound() {
            initAudio();
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6

            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.05);
                oscillator.type = 'sine';

                const startTime = audioContext.currentTime + index * 0.05;
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.1, startTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 1.5);

                oscillator.start(startTime);
                oscillator.stop(startTime + 1.5);
            });
        }

        // é€‰æ‹©éŸ³æ•ˆ - æ¸…è„†çš„ç¡®è®¤éŸ³
        function playSelectSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
            oscillator.frequency.exponentialRampToValueAtTime(1760, audioContext.currentTime + 0.1); // A6
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // å–æ¶ˆé€‰æ‹©éŸ³æ•ˆ - ä½æ²‰çš„å–æ¶ˆéŸ³
        function playDeselectSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
            oscillator.frequency.exponentialRampToValueAtTime(220, audioContext.currentTime + 0.1); // A3
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
        }

        // é”™è¯¯/é™åˆ¶éŸ³æ•ˆ - æç¤ºéŸ³
        function playErrorSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.type = 'sawtooth';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // æ¸²æŸ“ç›®æ ‡å¡ç‰‡
        // æ·»åŠ ç›®æ ‡å¡ç‰‡
        function addGoalCard(text) {
            console.log('addGoalCard è¢«è°ƒç”¨:', text);
            playCardSound();

            const icons = ['ğŸ¯', 'ğŸ’ª', 'ğŸ“š', 'ğŸƒ', 'ğŸ’¼', 'ğŸš€', 'âœ¨', 'ğŸŒŸ', 'ğŸ”¥', 'ğŸ’'];
            const randomIcon = icons[Math.floor(Math.random() * icons.length)];

            const goal = {
                id: Date.now() + Math.random(),
                text: text,
                icon: randomIcon,
                selected: false
            };

            console.log('æ·»åŠ ç›®æ ‡:', goal);
            allGoalsList.push(goal);
            console.log('å½“å‰ç›®æ ‡åˆ—è¡¨é•¿åº¦:', allGoalsList.length);
            renderGoalCards();
            updateGoalCount();
            console.log('addGoalCard æ‰§è¡Œå®Œæˆ');
        }

        function renderGoalCards() {
            const container = document.getElementById('goalsCards');

            if (allGoalsList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">âœ¨</span>
                        åœ¨ä¸Šé¢è¾“å…¥æ¡†ä¸­å†™ä¸‹ä½ çš„ç¬¬ä¸€ä¸ªç›®æ ‡
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            allGoalsList.forEach((goal, index) => {
                const card = document.createElement('div');
                card.className = 'goal-card';
                card.style.animationDelay = `${index * 0.05}s`;
                card.innerHTML = `
                    <span class="icon">${goal.icon}</span>
                    <span class="text">${escapeHtml(goal.text)}</span>
                    <span class="remove-btn" onclick="removeGoalCard(${index})">âœ•</span>
                `;
                container.appendChild(card);
            });
        }

        // åˆ é™¤ç›®æ ‡å¡ç‰‡
        function removeGoalCard(index) {
            const cards = document.querySelectorAll('.goal-card');
            if (cards[index]) {
                cards[index].classList.add('removing');
                setTimeout(() => {
                    allGoalsList.splice(index, 1);
                    renderGoalCards();
                    updateGoalCount();
                }, 300);
            }
        }

        // æ›´æ–°ç›®æ ‡è®¡æ•°
        function updateGoalCount() {
            document.getElementById('goalCount').textContent = allGoalsList.length;
        }
        function loadFromStorage() {
            const saved = localStorage.getItem('focus2026_data');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.step) {
                    allGoalsList = data.allGoalsList || [];
                    top5Goals = data.top5Goals || [];
                    top3Goals = data.top3Goals || [];
                    weights = data.weights || [0, 0, 0];

                    // æ¢å¤åˆ°å¯¹åº”æ­¥éª¤
                    if (data.step >= 1) {
                        goToStep(1);
                        updateProgress(20);
                        renderGoalCards();
                        updateGoalCount();
                    }
                    if (data.step >= 2) {
                        goToStep(2);
                        updateProgress(40);
                        renderStep2List();
                    }
                    if (data.step >= 3) {
                        goToStep(3);
                        updateProgress(60);
                        renderStep3List();
                    }
                    if (data.step >= 4) {
                        goToStep(4);
                        updateProgress(80);
                        renderWeightSection();
                    }
                    if (data.step >= 5) {
                        goToStep(5);
                        updateProgress(100);
                        generateCard();
                        loadStreakData();
                    }
                }
            } else {
                updateProgress(20);
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToStorage(step) {
            const data = {
                step: step,
                allGoalsList: allGoalsList,
                top5Goals: top5Goals,
                top3Goals: top3Goals,
                weights: weights
            };
            localStorage.setItem('focus2026_data', JSON.stringify(data));
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // åˆ‡æ¢æ­¥éª¤
        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + stepNum).classList.add('active');
        }

        // Toast æç¤ºå‡½æ•°
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            toast.className = 'toast ' + type;
            msg.textContent = message;

            if (type === 'success') icon.textContent = 'âœ“';
            else if (type === 'error') icon.textContent = 'âœ•';
            else icon.textContent = 'â„¹';

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Step 1 -> Step 2
        function goToStep2() {
            if (allGoalsList.length === 0) {
                showToast('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç›®æ ‡', 'error');
                return;
            }

            playReleaseSound();

            saveToStorage(1);
            goToStep(2);
            updateProgress(40);
            renderStep2List();

            // å¦‚æœæ˜¯æ¼”ç¤ºæ¨¡å¼ï¼Œç»§ç»­åç»­æ­¥éª¤
            if (isDemoRunning && window.demoStep2) {
                window.demoStep2();
            }
        }

        // æ¸²æŸ“Step 2åˆ—è¡¨
        function renderStep2List() {
            const container = document.getElementById('step2List');
            container.innerHTML = '';

            allGoalsList.forEach(goal => {
                const item = document.createElement('div');
                item.className = 'goal-item' + (goal.selected ? ' selected' : '');
                item.onclick = () => toggleStep2Goal(goal.id);
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="text">${escapeHtml(goal.text)}</div>
                `;
                container.appendChild(item);
            });

            updateStep2Count();
        }

        // åˆ‡æ¢Step 2é€‰ä¸­çŠ¶æ€
        function toggleStep2Goal(id) {
            if (isDemoRunning) return;

            const goal = allGoalsList.find(g => g.id === id);
            if (goal) {
                const selectedCount = allGoalsList.filter(g => g.selected).length;
                if (!goal.selected && selectedCount >= 5) {
                    playErrorSound();
                    return;
                }
                goal.selected = !goal.selected;
                if (goal.selected) {
                    playSelectSound();
                } else {
                    playDeselectSound();
                }
                renderStep2List();
            }
        }

        // æ›´æ–°Step 2é€‰æ‹©è®¡æ•°
        function updateStep2Count() {
            const count = allGoalsList.filter(g => g.selected).length;
            document.getElementById('step2Count').textContent = `å·²é€‰æ‹© ${count}/5`;
        }

        // Step 2 -> Step 3
        function goToStep3() {
            const selected = allGoalsList.filter(g => g.selected);
            const modeConfig = challengeModes[currentChallengeMode] || challengeModes['yearly3'];

            // å¦‚æœé€‰ä¸­çš„æ•°é‡ä¸è¶³5ä¸ªï¼Œä½†è‡³å°‘æœ‰1ä¸ªï¼Œå…è®¸ç»§ç»­
            if (selected.length === 0) {
                document.getElementById('step2Error').textContent = 'è¯·è‡³å°‘é€‰æ‹©1ä¸ªç›®æ ‡';
                return;
            }

            // å¦‚æœæ˜¯é»˜è®¤æ¨¡å¼ï¼Œè¦æ±‚è‡³å°‘é€‰æ‹©5ä¸ª
            if (currentChallengeMode === 'yearly3' && selected.length < 5) {
                document.getElementById('step2Error').textContent = 'è¯·è‡³å°‘é€‰æ‹©5ä¸ªç›®æ ‡';
                return;
            }

            document.getElementById('step2Error').textContent = '';

            // å¦‚æœé€‰ä¸­çš„æ•°é‡ä¸è¶³5ä¸ªï¼Œæ˜¾ç¤ºæç¤º
            if (selected.length < 5) {
                showToast(`å·²é€‰æ‹©${selected.length}ä¸ªç›®æ ‡ï¼Œç»§ç»­è¿›å…¥ä¸‹ä¸€æ­¥`, 'info');
            }

            top5Goals = selected.map(g => ({ ...g, selected: false }));
            saveToStorage(2);
            goToStep(3);
            updateProgress(60);
            renderStep3List();
        }

        // æ¸²æŸ“Step 3åˆ—è¡¨
        function renderStep3List() {
            const container = document.getElementById('step3List');
            container.innerHTML = '';

            top5Goals.forEach(goal => {
                const item = document.createElement('div');
                item.className = 'goal-item' + (goal.selected ? ' selected' : '');
                item.onclick = () => toggleStep3Goal(goal.id);
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="text">${escapeHtml(goal.text)}</div>
                `;
                container.appendChild(item);
            });

            updateStep3Count();
        }

        // åˆ‡æ¢Step 3é€‰ä¸­çŠ¶æ€
        function toggleStep3Goal(id) {
            if (isDemoRunning) return;

            const goal = top5Goals.find(g => g.id === id);
            if (goal) {
                const selectedCount = top5Goals.filter(g => g.selected).length;
                if (!goal.selected && selectedCount >= 3) {
                    playErrorSound();
                    return;
                }
                goal.selected = !goal.selected;
                if (goal.selected) {
                    playSelectSound();
                } else {
                    playDeselectSound();
                }
                renderStep3List();
            }
        }

        // æ›´æ–°Step 3é€‰æ‹©è®¡æ•°
        function updateStep3Count() {
            const count = top5Goals.filter(g => g.selected).length;
            document.getElementById('step3Count').textContent = `å·²é€‰æ‹© ${count}/3`;
        }

        // Step 3 -> Step 4
        function goToStep4() {
            const selected = top5Goals.filter(g => g.selected);
            const modeConfig = challengeModes[currentChallengeMode] || challengeModes['yearly3'];

            // å¦‚æœé€‰ä¸­çš„æ•°é‡ä¸º0ï¼Œä¸èƒ½ç»§ç»­
            if (selected.length === 0) {
                document.getElementById('step3Error').textContent = 'è¯·è‡³å°‘é€‰æ‹©1ä¸ªç›®æ ‡';
                return;
            }

            // å¦‚æœé€‰ä¸­çš„æ•°é‡ä¸è¶³3ä¸ªï¼Œå…è®¸ç»§ç»­
            if (selected.length < 3) {
                document.getElementById('step3Error').textContent = '';
                showToast(`å·²é€‰æ‹©${selected.length}ä¸ªç›®æ ‡ï¼Œç»§ç»­è¿›å…¥ä¸‹ä¸€æ­¥`, 'info');
            } else {
                document.getElementById('step3Error').textContent = '';
            }

            top3Goals = selected.map((g, index) => ({ ...g, weight: 0 }));

            // åˆå§‹åŒ–æƒé‡æ•°ç»„ï¼Œæ ¹æ®é€‰ä¸­çš„æ•°é‡
            weights = new Array(selected.length).fill(0);
            saveToStorage(3);
            goToStep(4);
            updateProgress(80);
            renderWeightSection();
        }

        // æ¸²æŸ“æƒé‡åˆ†é…åŒºåŸŸ
        function renderWeightSection() {
            const container = document.getElementById('weightSection');
            container.innerHTML = '';

            top3Goals.forEach((goal, index) => {
                const item = document.createElement('div');
                item.className = 'weight-item';
                item.innerHTML = `
                    <div class="weight-label">${escapeHtml(goal.text)}</div>
                    <input type="range" class="weight-slider" min="0" max="100" step="5" value="${weights[index]}"
                        oninput="updateWeight(${index}, this.value)">
                    <div style="text-align: center; margin-top: 5px; font-weight: bold; color: #667eea;">
                        ${weights[index]}%
                    </div>
                `;
                container.appendChild(item);
            });

            updateWeightTotal();
        }

        // æ›´æ–°æƒé‡
        function updateWeight(index, value) {
            if (isDemoRunning) return;

            weights[index] = parseInt(value);
            renderWeightSection();
            updateWeightTotal();
        }

        // æ›´æ–°æƒé‡æ€»å’Œæ˜¾ç¤º
        function updateWeightTotal() {
            const total = weights.reduce((a, b) => a + b, 0);
            const totalEl = document.getElementById('weightTotal');
            totalEl.textContent = `å½“å‰æ€»å’Œï¼š${total}%`;

            if (total === 100) {
                totalEl.className = 'weight-total valid';
                document.getElementById('step4Error').textContent = '';
            } else {
                totalEl.className = 'weight-total invalid';
                document.getElementById('step4Error').textContent = 'æƒé‡æ€»å’Œå¿…é¡»æ˜¯100%';
            }
        }

        // Step 4 -> Step 5: ç”Ÿæˆä¸“æ³¨å¡
        function generateCard() {
            const total = weights.reduce((a, b) => a + b, 0);
            if (total !== 100) {
                showToast('æƒé‡æ€»å’Œå¿…é¡»æ˜¯100%', 'error');
                return;
            }

            saveToStorage(4);
            goToStep(5);
            updateProgress(100);

            // ç»˜åˆ¶Canvas - 9:16 æ¯”ä¾‹ï¼Œé€‚åˆæ‰‹æœºå£çº¸
            const canvas = document.getElementById('focusCard');
            const ctx = canvas.getContext('2d');

            // æ‰‹æœºå£çº¸æ ‡å‡†å°ºå¯¸ 1080x1920
            canvas.width = 1080;
            canvas.height = 1920;

            // å®‰å…¨åŒºåŸŸï¼ˆé¿å¼€çŠ¶æ€æ å’Œåº•éƒ¨å¯¼èˆªï¼‰
            const safeTop = 120;
            const safeBottom = 180;

            // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(0.5, '#764ba2');
            gradient.addColorStop(1, '#f093fb');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // æ·»åŠ è£…é¥°æ€§åœ†å½¢
            ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
            ctx.beginPath();
            ctx.arc(canvas.width * 0.85, canvas.height * 0.15, 350, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath();
            ctx.arc(canvas.width * 0.15, canvas.height * 0.85, 280, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath();
            ctx.arc(canvas.width * 0.5, canvas.height * 0.5, 500, 0, Math.PI * 2);
            ctx.fill();

            // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ - æ ¹æ®æŒ‘æˆ˜æ¨¡å¼åŠ¨æ€æ˜¾ç¤º
            const modeConfig = challengeModes[currentChallengeMode] || challengeModes['yearly3'];
            ctx.fillStyle = 'white';
            ctx.font = 'bold 100px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
            ctx.shadowBlur = 20;
            ctx.shadowOffsetY = 10;
            ctx.fillText(modeConfig.year, canvas.width / 2, safeTop + 100);

            ctx.shadowColor = 'transparent';
            ctx.font = '500 42px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillText(modeConfig.displayTitle, canvas.width / 2, safeTop + 170);

            // æ·»åŠ è£…é¥°çº¿
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 100, safeTop + 200);
            ctx.lineTo(canvas.width / 2 + 100, safeTop + 200);
            ctx.stroke();

            // è®¡ç®—å¡ç‰‡å¸ƒå±€
            const cardStartY = safeTop + 280;
            const cardHeight = 380;
            const cardGap = 40;
            const cardMargin = 60;

            top3Goals.forEach((goal, index) => {
                const y = cardStartY + index * (cardHeight + cardGap);

                // ç»˜åˆ¶å¡ç‰‡é˜´å½±
                ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.beginPath();
                ctx.roundRect(cardMargin + 5, y + 5, canvas.width - cardMargin * 2, cardHeight, 25);
                ctx.fill();

                // ç»˜åˆ¶å¡ç‰‡èƒŒæ™¯
                ctx.fillStyle = 'rgba(255, 255, 255, 0.98)';
                ctx.beginPath();
                ctx.roundRect(cardMargin, y, canvas.width - cardMargin * 2, cardHeight, 25);
                ctx.fill();

                // ç»˜åˆ¶æƒé‡æ ‡ç­¾ï¼ˆåœ†å½¢èƒŒæ™¯ï¼‰
                const weightSize = 90;
                const weightX = cardMargin + 50;
                const weightY = y + 50;

                // æƒé‡åœ†å½¢æ¸å˜èƒŒæ™¯
                const weightGradient = ctx.createLinearGradient(weightX, weightY, weightX + weightSize, weightY + weightSize);
                weightGradient.addColorStop(0, '#667eea');
                weightGradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = weightGradient;
                ctx.beginPath();
                ctx.arc(weightX + weightSize/2, weightY + weightSize/2, weightSize/2, 0, Math.PI * 2);
                ctx.fill();

                // æƒé‡æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.font = 'bold 36px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${weights[index]}%`, weightX + weightSize/2, weightY + weightSize/2);

                // ç›®æ ‡æ–‡å­—
                ctx.fillStyle = '#333';
                ctx.font = 'bold 44px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'alphabetic';

                const textX = weightX + weightSize + 35;
                const textY = y + 90;
                const maxWidth = canvas.width - cardMargin * 2 - textX - 30;
                const lineHeight = 65;
                const text = goal.text;
                const words = text.split('');
                let line = '';
                let lineCount = 0;
                const maxLines = 3;

                for (let i = 0; i < words.length && lineCount < maxLines; i++) {
                    const testLine = line + words[i];
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && line.length > 0) {
                        ctx.fillText(line, textX, textY + lineCount * lineHeight);
                        line = words[i];
                        lineCount++;
                    } else {
                        line = testLine;
                    }
                }
                if (line.length > 0 && lineCount < maxLines) {
                    ctx.fillText(line, textX, textY + lineCount * lineHeight);
                }

                // åºå·
                ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
                ctx.font = 'bold 120px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${index + 1}`, canvas.width - cardMargin - 30, y + 130);
            });

            // åº•éƒ¨æ ‡è¯­
            const bottomY = canvas.height - safeBottom - 80;

            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'italic 40px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('å…¶ä»–çš„ï¼Œè®©å®ƒä»¬å»å§', canvas.width / 2, bottomY);

            // æ·»åŠ æ—¥æœŸ
            const now = new Date();
            const dateStr = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.font = '28px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
            ctx.fillText(dateStr, canvas.width / 2, bottomY + 50);

            saveToStorage(5);
            loadStreakData();

            // å®Œæˆä¸“æ³¨å¡å¥–åŠ±
            const firstCardKey = 'focus2026_first_card_completed';
            if (!localStorage.getItem(firstCardKey)) {
                addPoints(50, 'å®Œæˆä¸“æ³¨å¡');
                addAchievement('firstCard');
                localStorage.setItem(firstCardKey, 'true');
            } else {
                addPoints(50, 'å®Œæˆä¸“æ³¨å¡');
            }

            updatePointsDisplay();
        }

        // ä¸‹è½½ä¸“æ³¨å¡
        function downloadCard() {
            const canvas = document.getElementById('focusCard');
            const link = document.createElement('a');
            link.download = '2026ä¸“æ³¨å¡.png';
            link.href = canvas.toDataURL('image/png');
            link.click();

            showToast('ä¸“æ³¨å¡å·²ä¸‹è½½ï¼Œè®¾ä¸ºå£çº¸å§ï¼', 'success');
        }

        // é‡æ–°å¼€å§‹
        function restart() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è¿›åº¦å°†è¢«æ¸…é™¤ã€‚')) {
                localStorage.removeItem('focus2026_data');
                localStorage.removeItem('focus2026_streak');
                location.reload();
            }
        }

        // æŒ‘æˆ˜æ¨¡å¼é…ç½®
        const challengeModes = {
            daily1: { name: 'ä¸€å¤©1ä»¶äº‹', year: '2026', displayTitle: 'ä¸€å¤©ï¼Œåªåšä¸€ä»¶äº‹', count: 1, unit: 'å¤©', icon: 'ğŸ“…' },
            daily3: { name: 'ä¸€å¤©3ä»¶äº‹', year: '2026', displayTitle: 'ä¸€å¤©ï¼Œåªåšä¸‰ä»¶äº‹', count: 3, unit: 'å¤©', icon: 'ğŸ“…' },
            weekly3: { name: 'ä¸€å‘¨3ä»¶äº‹', year: '2026', displayTitle: 'ä¸€å‘¨ï¼Œåªåšä¸‰ä»¶äº‹', count: 3, unit: 'å‘¨', icon: 'ğŸ“†' },
            monthly3: { name: 'ä¸€æœˆ3ä»¶äº‹', year: '2026', displayTitle: 'ä¸€æœˆï¼Œåªåšä¸‰ä»¶äº‹', count: 3, unit: 'æœˆ', icon: 'ğŸ—“ï¸' },
            yearly3: { name: '2026å¹´3ä»¶äº‹', year: '2026', displayTitle: 'è¿™ä¸€å¹´ï¼Œåªåšä¸‰ä»¶äº‹', count: 3, unit: 'å¹´', icon: 'ğŸ¯' },
            oneLife: { name: 'ä¸€ç”Ÿ1ä»¶äº‹', year: 'ä¸€ç”Ÿ', displayTitle: 'ä¸€ç”Ÿï¼Œåªåšä¸€ä»¶äº‹', count: 1, unit: 'ä¸€ç”Ÿ', icon: 'â­' }
        };

        // æ‰“å¼€æŒ‘æˆ˜æ¨¡å¼
        function openChallenge(mode) {
            const config = challengeModes[mode];
            currentChallengeMode = mode; // ä¿å­˜å½“å‰é€‰ä¸­çš„æ¨¡å¼
            const input = document.getElementById('allGoals');
            const placeholder = config.count === 1
                ? `è¾“å…¥ä½ è¦ä¸“æ³¨çš„1ä»¶äº‹ï¼ˆ${config.unit}ï¼‰...`
                : `è¾“å…¥ä½ è¦ä¸“æ³¨çš„${config.count}ä»¶äº‹ï¼ˆ${config.unit}ï¼‰ï¼Œæ¯è¡Œä¸€ä¸ª...`;

            input.placeholder = placeholder;
            input.rows = config.count > 3 ? '4' : '3';
            input.style.display = 'block';
            input.value = '';

            // æ›´æ–°Step 1æè¿°æ–‡å­—
            updateStep1Description();

            // éšè—å…¶ä»–æ­¥éª¤ï¼Œåªæ˜¾ç¤ºè¾“å…¥
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1').classList.add('active');

            // æ¸…ç©ºç°æœ‰æ•°æ®
            allGoalsList = [];
            top5Goals = [];
            top3Goals = [];
            weights = [0, 0, 0];

            saveToStorage(0);
            goToStep(1);
            updateProgress(20);
            updateGoalCount();

            // æ»šåŠ¨åˆ°è¾“å…¥æ¡†
            input.scrollIntoView({ behavior: 'smooth' });
            input.focus();

            playSelectSound();
            showToast(`å·²åˆ‡æ¢åˆ°${config.name}æ¨¡å¼`, 'info');
        }

        // æ›´æ–°Step 1æè¿°æ–‡å­—
        function updateStep1Description() {
            const descEl = document.getElementById('step1Desc');
            const modeConfig = challengeModes[currentChallengeMode] || challengeModes['yearly3'];

            // æ ¹æ®æ¨¡å¼ç”Ÿæˆå¯¹åº”çš„æè¿°æ–‡å­—
            let timeText = '';
            switch (currentChallengeMode) {
                case 'daily1':
                case 'daily3':
                    timeText = 'ä»Šå¤©';
                    break;
                case 'weekly3':
                    timeText = 'è¿™å‘¨';
                    break;
                case 'monthly3':
                    timeText = 'è¿™ä¸ªæœˆ';
                    break;
                case 'yearly3':
                    timeText = '2026å¹´';
                    break;
                case 'oneLife':
                    timeText = 'ä¸€ç”Ÿ';
                    break;
                default:
                    timeText = '2026å¹´';
            }

            descEl.textContent = `æŠŠä½ ${timeText}æƒ³åšçš„æ‰€æœ‰äº‹æƒ…éƒ½å†™ä¸‹æ¥ï¼Œä¸é™æ•°é‡ï¼Œä¸ç”¨æ’åºã€‚è®©å¤§è„‘æ¸…ç©ºã€‚`;
        }

        // è¿”å›é‡æ–°é€‰æ‹©ç›®æ ‡
        function goBackToSelect() {
            if (confirm('è¿”å›é¦–é¡µé‡æ–°è¾“å…¥ç›®æ ‡ï¼Ÿå½“å‰æ‰€æœ‰è¿›åº¦å°†è¢«é‡ç½®ã€‚')) {
                // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                allGoalsList = [];
                top5Goals = [];
                top3Goals = [];
                weights = [0, 0, 0];

                // æ¸…ç©ºè¾“å…¥æ¡†
                const textarea = document.getElementById('allGoals');
                if (textarea) {
                    textarea.value = '';
                }

                // ä¿å­˜çŠ¶æ€
                saveToStorage(1);

                // è¿”å› Step 1ï¼ˆé¦–é¡µï¼‰
                goToStep(1);
                updateProgress(20);
                renderGoalCards();
                updateGoalCount();

                showToast('å¯ä»¥é‡æ–°è¾“å…¥ç›®æ ‡äº†', 'info');
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== æ¼”ç¤ºæ¨¡å¼ =====
        function startDemo() {
            isDemoRunning = true;
            localStorage.removeItem('focus2026_data');
            localStorage.removeItem('focus2026_streak');
            allGoalsList = [];
            top5Goals = [];
            top3Goals = [];

            const demoGoals = [
                'å­©å­ä¸­è€ƒè€ƒä¸Šå¥½é«˜ä¸­',
                'é˜…è¯»52æœ¬ä¹¦',
                'è·‘å®Œ1000å…¬é‡Œä¿æŒå¥åº·',
                'ç”¨AIåˆ›ä¸š',
                'åšå†…å®¹åˆ›ä¸š',
                'å­¦ä¹ Pythonç¼–ç¨‹',
                'æ¯å‘¨å†™3ç¯‡æ–‡ç« ',
                'å­¦ä¼šé’¢ç´åŸºç¡€'
            ];

            // Step 1: æ¸…ç©ºå¹¶å›åˆ°ç¬¬ä¸€æ­¥
            goToStep(1);
            updateProgress(20);
            document.getElementById('allGoals').value = '';
            renderGoalCards();
            updateGoalCount();

            // é€ä¸ªæ·»åŠ ç›®æ ‡å¡ç‰‡
            let goalIndex = 0;
            function addNextGoal() {
                if (goalIndex < demoGoals.length) {
                    const textarea = document.getElementById('allGoals');
                    textarea.value = demoGoals[goalIndex];
                    addGoalCard(demoGoals[goalIndex]);
                    textarea.value = '';
                    goalIndex++;
                    setTimeout(addNextGoal, 400); // æ¯0.4ç§’æ·»åŠ ä¸€ä¸ª
                } else {
                    // æ‰€æœ‰ç›®æ ‡æ·»åŠ å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
                    setTimeout(() => {
                        playReleaseSound();
                        goToStep2();
                    }, 500);
                }
            }

            setTimeout(addNextGoal, 500); // å¼€å§‹æ·»åŠ ç›®æ ‡

            // é‡æ–°å®šä¹‰ Step 2-5 çš„æ¼”ç¤ºé€»è¾‘ï¼ˆåœ¨ addNextGoal å®Œæˆåæ‰§è¡Œï¼‰
            window.demoStep2 = function() {
                allGoalsList = demoGoals.map((text, i) => ({
                    id: i,
                    text,
                    icon: ['ğŸ¯', 'ğŸ’ª', 'ğŸ“š', 'ğŸƒ', 'ğŸ’¼', 'ğŸš€', 'âœ¨', 'ğŸŒŸ'][i % 8],
                    selected: false
                }));
                renderStep2List();

                // Step 2: é€‰5ä¸ª
                setTimeout(() => {
                    const toSelect = [0, 1, 2, 3, 4];
                    toSelect.forEach((id, idx) => {
                        setTimeout(() => {
                            allGoalsList[id].selected = true;
                            renderStep2List();
                        }, idx * 300);
                    });

                    setTimeout(() => {
                        goToStep3();
                        top5Goals = allGoalsList.filter(g => g.selected).map(g => ({ ...g, selected: false }));
                        renderStep3List();

                        // Step 3: é€‰3ä¸ª
                        setTimeout(() => {
                            const toSelect3 = [0, 1, 2];
                            toSelect3.forEach((relativeId, idx) => {
                                setTimeout(() => {
                                    top5Goals[relativeId].selected = true;
                                    renderStep3List();
                                }, idx * 300);
                            });

                            setTimeout(() => {
                                goToStep4();
                                top3Goals = top5Goals.filter(g => g.selected).map((g, i) => ({ ...g, weight: 0 }));
                                renderWeightSection();

                                // Step 4: åˆ†é…æƒé‡
                                setTimeout(() => {
                                    weights = [50, 30, 20];
                                    renderWeightSection();
                                    updateWeightTotal();

                                    setTimeout(() => {
                                        generateCard();

                                    setTimeout(() => {
                                        isDemoRunning = false;
                                        localStorage.removeItem('focus2026_data');
                                        localStorage.removeItem('focus2026_streak');
                                        showToast('æ¼”ç¤ºå®Œæˆï¼ç°åœ¨è½®åˆ°ä½ äº†', 'success');
                                    }, 2000);
                                    }, 1000);
                                }, 1000);
                            }, 1500);
                        }, 2000);
                    }, 2000);
                }, 1500);
            };
        }

        // ===== ç”¨æˆ·ç•™å­˜åŠŸèƒ½ =====

        // åŠ è½½æ‰“å¡æ•°æ®
        function loadStreakData() {
            const streakData = JSON.parse(localStorage.getItem('focus2026_streak') || '{"streak": 0, "lastDate": null}');
            const today = new Date().toDateString();
            const lastDate = streakData.lastDate;

            // æ£€æŸ¥æ˜¯å¦è¿ç»­
            if (lastDate) {
                const last = new Date(lastDate);
                const now = new Date(today);
                const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));

                if (diffDays > 1) {
                    // æ–­äº†ï¼Œé‡ç½®
                    streakData.streak = 0;
                }
            }

            document.getElementById('streakCount').textContent = streakData.streak;

            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡
            if (lastDate === today) {
                document.getElementById('checkinBtn').disabled = true;
                document.getElementById('checkinBtn').textContent = 'âœ“ å·²æ‰“å¡';
            }
        }

        // æ¯æ—¥æ‰“å¡
        function dailyCheckin() {
            const streakData = JSON.parse(localStorage.getItem('focus2026_streak') || '{"streak": 0, "lastDate": null}');
            const today = new Date().toDateString();

            if (streakData.lastDate === today) {
                return;
            }

            streakData.streak++;
            streakData.lastDate = today;
            localStorage.setItem('focus2026_streak', JSON.stringify(streakData));

            document.getElementById('streakCount').textContent = streakData.streak;
            document.getElementById('checkinBtn').disabled = true;
            document.getElementById('checkinBtn').textContent = 'âœ“ å·²æ‰“å¡';

            // æ‰“å¡å¥–åŠ±æç¤º
            const messages = [
                'å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼',
                'ä¸“æ³¨åŠ›+1ï¼',
                'ä½ æ¯”æ˜¨å¤©æ›´è¿›ä¸€æ­¥ï¼',
                'è¿ç»­æ‰“å¡å°±æ˜¯èƒœåˆ©ï¼',
                'æ¯ä¸€ä»½åšæŒéƒ½ç®—æ•°ï¼'
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            showToast(randomMsg, 'success');
        }

        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            const url = 'https://sangzhexianxian.github.io/focus/';
            const shareText = `2026å¹´ï¼Œæˆ‘åªåš3ä»¶äº‹ï¼Œå…¶ä»–çš„éƒ½æ”¾å¼ƒï¼è¿™ä¸ªå·¥å…·å¸®æˆ‘æ‰¾åˆ°äº†çœŸæ­£é‡è¦çš„ç›®æ ‡ğŸ”¥\n\n${url}`;

            // ä¼˜å…ˆä½¿ç”¨ç°ä»£ API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showCopySuccess();
                    addPoints(15, 'åˆ†äº«ä¸“æ³¨å¡');
                }).catch(() => {
                    fallbackCopy(shareText);
                });
            } else {
                fallbackCopy(shareText);
            }
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                // æœ€åçš„ä¿åº•æ–¹æ¡ˆï¼šprompt
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼š', text);
            }

            document.body.removeChild(textarea);
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopySuccess() {
            const success = document.getElementById('copySuccess');
            success.style.display = 'inline';
            setTimeout(() => {
                success.style.display = 'none';
            }, 3000);
        }

        // ===== ç”¨æˆ·è®¤è¯ç›¸å…³ =====

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            if (!supabaseClient) {
                console.log('Supabase æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                currentUser = null;
                isCloudMode = false;
                updateUserUI(false);
                loadFromStorage();
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('è·å–ä¼šè¯å¤±è´¥:', error);
                    throw error;
                }

                if (session) {
                    currentUser = session.user;
                    isCloudMode = true;
                    updateUserUI(true);
                    await loadFromCloud();
                } else {
                    currentUser = null;
                    isCloudMode = false;
                    updateUserUI(false);
                    loadFromStorage();
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                currentUser = null;
                isCloudMode = false;
                updateUserUI(false);
                loadFromStorage();
            }
        }

        // æ˜¾ç¤ºç™»å½•å¼¹çª—
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            showLoginForm();
        }

        // éšè—ç™»å½•å¼¹çª—
        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        // æ˜¾ç¤ºç§¯åˆ†å¼¹çª—
        function showPointsModal() {
            updatePointsModal();
            document.getElementById('pointsModal').classList.add('show');
        }

        // éšè—ç§¯åˆ†å¼¹çª—
        function hidePointsModal() {
            document.getElementById('pointsModal').classList.remove('show');
        }

        // æ›´æ–°ç§¯åˆ†å¼¹çª—å†…å®¹
        function updatePointsModal() {
            // æ›´æ–°ç§¯åˆ†æ¦‚è§ˆ
            document.getElementById('modalTotalPoints').textContent = userPoints.total;
            const levelInfo = levelConfig[userPoints.level];
            document.getElementById('modalUserLevel').textContent = `LV${userPoints.level} ${levelInfo.name}`;
            document.getElementById('modalUserLevel').style.color = levelInfo.color;
            document.getElementById('modalStreak').textContent = userPoints.checkInStreak;

            // æ›´æ–°ç­‰çº§è¿›åº¦
            const currentLevelPoints = levelConfig[userPoints.level].points;
            const nextLevelPoints = levelConfig[userPoints.level + 1]
                ? levelConfig[userPoints.level + 1].points
                : currentLevelPoints * 2;
            const progress = userPoints.total - currentLevelPoints;
            const target = nextLevelPoints - currentLevelPoints;
            const percent = Math.min((progress / target) * 100, 100);

            document.getElementById('levelProgress').textContent = `${progress} / ${target}`;
            document.getElementById('levelProgressBar').style.width = `${percent}%`;

            // æ›´æ–°æ¯æ—¥ç­¾åˆ°çŠ¶æ€
            const today = new Date().toDateString();
            const checkInSection = document.getElementById('dailyCheckInSection');
            if (userPoints.lastCheckInDate === today) {
                checkInSection.innerHTML = `
                    <h4 style="margin-bottom: 8px; color: #155724;">âœ“ ä»Šæ—¥å·²ç­¾åˆ°</h4>
                    <p style="margin: 0; font-size: 13px; color: #155724;">æ˜å¤©å†æ¥ç­¾åˆ°å§</p>
                `;
                checkInSection.style.cursor = 'default';
                checkInSection.onclick = null;
            } else {
                checkInSection.innerHTML = `
                    <h4 style="margin-bottom: 8px; color: #155724;">ğŸ“… æ¯æ—¥ç­¾åˆ°</h4>
                    <p style="margin: 0; font-size: 13px; color: #155724;">ç­¾åˆ°è·å¾— +10 ç§¯åˆ†ï¼Œè¿ç»­ç­¾åˆ°æœ‰é¢å¤–å¥–åŠ±</p>
                `;
                checkInSection.style.cursor = 'pointer';
                checkInSection.onclick = dailyCheckIn;
            }

            // æ›´æ–°æˆå°±åˆ—è¡¨
            updateAchievementsList();
        }

        // æ›´æ–°æˆå°±åˆ—è¡¨
        function updateAchievementsList() {
            const container = document.getElementById('achievementsList');

            if (userPoints.achievements.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; color: #999; font-size: 13px; grid-column: 1 / -1;">
                        æš‚æ— æˆå°±ï¼Œå¿«å»å®Œæˆä»»åŠ¡å§ï¼
                    </div>
                `;
                return;
            }

            container.innerHTML = userPoints.achievements.map(id => {
                const achievement = achievementConfig[id];
                return `
                    <div class="achievement-item">
                        <div class="icon">${achievement.icon}</div>
                        <div class="name">${achievement.name}</div>
                        <div class="desc">+${achievement.points}åˆ†</div>
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        // æ¸¸å®¢æ¨¡å¼ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
        function handleGuestLogin() {
            currentUser = null;
            isCloudMode = false;
            updateUserUI(false);
            hideLoginModal();
            showToast('å·²è¿›å…¥æ¸¸å®¢æ¨¡å¼ï¼Œæ•°æ®ä¿å­˜åœ¨æœ¬åœ°', 'info');
            loadFromStorage();
        }

        // å¿˜è®°å¯†ç 
        function showForgotPassword() {
            event.preventDefault();
            const email = prompt('è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼Œæˆ‘ä»¬å°†å‘é€å¯†ç é‡ç½®é“¾æ¥ï¼š');

            if (email && email.trim()) {
                if (!supabaseClient) {
                    showToast('äº‘ç«¯æœåŠ¡æœªåˆå§‹åŒ–', 'error');
                    return;
                }

                // è¿™é‡Œå¯ä»¥è°ƒç”¨ Supabase çš„å¯†ç é‡ç½®åŠŸèƒ½
                showToast('å¯†ç é‡ç½®é“¾æ¥å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±', 'info');
            }
        }

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // å¤„ç†ç™»å½•
        async function handleLogin() {
            if (!supabaseClient) {
                showToast('äº‘ç«¯æœåŠ¡æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginSubmitBtn');

            if (!email || !password) {
                showToast('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    console.error('ç™»å½•é”™è¯¯:', error);
                    throw error;
                }

                currentUser = data.user;
                isCloudMode = true;
                updateUserUI(true);
                hideLoginModal();
                showToast('ç™»å½•æˆåŠŸï¼', 'success');
                await loadFromCloud();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                const errorMsg = error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ';
                showToast(errorMsg, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™»å½•';
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister() {
            if (!supabaseClient) {
                showToast('äº‘ç«¯æœåŠ¡æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return;
            }

            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const btn = document.getElementById('registerSubmitBtn');

            if (!email || !password) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            // é‚®ç®±æ ¼å¼éªŒè¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            if (!agreeTerms) {
                showToast('è¯·å…ˆé˜…è¯»å¹¶åŒæ„æœåŠ¡æ¡æ¬¾', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æ³¨å†Œä¸­...';

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: window.location.href
                    }
                });

                if (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error);

                    // ç‰¹æ®Šé”™è¯¯å¤„ç†
                    if (error.message.includes('User already registered')) {
                        showToast('è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•', 'error');
                    } else {
                        throw error;
                    }
                    return;
                }

                showToast('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ç¡®è®¤è´¦å·', 'success');
                showLoginForm();
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                const errorMsg = error.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                showToast(errorMsg, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ³¨å†Œ';
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿæœ¬åœ°æ•°æ®å°†ä¸ä¼šåˆ é™¤ã€‚')) return;

            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }

            currentUser = null;
            isCloudMode = false;
            updateUserUI(false);
            loadFromStorage();
            hideUserMenu();
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        }

        // æ›´æ–°ç”¨æˆ·UI
        function updateUserUI(isLoggedIn) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            const bottomLoginBtn = document.getElementById('bottomLoginBtn');
            const bottomLoggedInActions = document.getElementById('bottomLoggedInActions');

            if (isLoggedIn && currentUser) {
                syncStatus.classList.add('show', 'synced');
                syncText.textContent = 'å·²ç™»å½•';
                // åº•éƒ¨æ æ˜¾ç¤ºç™»å½•åçš„æ“ä½œ
                if (bottomLoginBtn) {
                    bottomLoginBtn.style.display = 'none';
                }
                if (bottomLoggedInActions) {
                    bottomLoggedInActions.style.display = 'flex';
                }
            } else {
                syncStatus.classList.remove('show', 'synced');
                syncText.textContent = 'æœ¬åœ°æ¨¡å¼';
                // åº•éƒ¨æ æ˜¾ç¤ºç™»å½•æŒ‰é’®
                if (bottomLoginBtn) {
                    bottomLoginBtn.style.display = 'inline-block';
                }
                if (bottomLoggedInActions) {
                    bottomLoggedInActions.style.display = 'none';
                }
            }
        }

        // åˆ‡æ¢ç”¨æˆ·èœå•
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');

            // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.user-info')) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // éšè—ç”¨æˆ·èœå•
        function hideUserMenu() {
            document.getElementById('userMenu').classList.remove('show');
        }

        // æŸ¥çœ‹ä¸ªäººèµ„æ–™
        function viewProfile() {
            hideUserMenu();
            if (currentUser) {
                alert(`é‚®ç®±ï¼š${currentUser.email}\nåˆ›å»ºæ—¶é—´ï¼š${new Date(currentUser.created_at).toLocaleDateString()}`);
            }
        }

        // ===== äº‘ç«¯åŒæ­¥ç›¸å…³ =====

        // ä»äº‘ç«¯åŠ è½½æ•°æ®
        async function loadFromCloud() {
            if (!currentUser || !supabaseClient) return;

            setSyncStatus('syncing');

            try {
                const { data, error } = await supabaseClient
                    .from('user_focus_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('æŸ¥è¯¢äº‘ç«¯æ•°æ®å¤±è´¥:', error);
                    throw error;
                }

                if (data && data.focus_data) {
                    const savedData = JSON.parse(data.focus_data);
                    if (savedData.step) {
                        allGoalsList = savedData.allGoalsList || [];
                        top5Goals = savedData.top5Goals || [];
                        top3Goals = savedData.top3Goals || [];
                        weights = savedData.weights || [0, 0, 0];

                        // æ¢å¤åˆ°å¯¹åº”æ­¥éª¤
                        if (savedData.step >= 1) {
                            goToStep(1);
                            updateProgress(20);
                            renderGoalCards();
                            updateGoalCount();
                        }
                        if (savedData.step >= 2) {
                            goToStep(2);
                            updateProgress(40);
                            renderStep2List();
                        }
                        if (savedData.step >= 3) {
                            goToStep(3);
                            updateProgress(60);
                            renderStep3List();
                        }
                        if (savedData.step >= 4) {
                            goToStep(4);
                            updateProgress(80);
                            renderWeightSection();
                        }
                        if (savedData.step >= 5) {
                            goToStep(5);
                            updateProgress(100);
                            generateCard();
                        }

                        setSyncStatus('synced');
                        showToast('æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥', 'info');
                    }
                } else {
                    loadFromStorage();
                }
            } catch (error) {
                console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error);
                setSyncStatus('error');
                showToast('åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                loadFromStorage();
            }
        }

        // ä¿å­˜åˆ°äº‘ç«¯
        async function saveToCloud(step) {
            if (!currentUser || !supabaseClient) return;

            const data = {
                step: step,
                allGoalsList: allGoalsList,
                top5Goals: top5Goals,
                top3Goals: top3Goals,
                weights: weights
            };

            setSyncStatus('syncing');

            try {
                const { data: existing, error: fetchError } = await supabaseClient
                    .from('user_focus_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;

                const now = new Date().toISOString();

                if (existing) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    await supabaseClient
                        .from('user_focus_data')
                        .update({
                            focus_data: JSON.stringify(data),
                            updated_at: now
                        })
                        .eq('user_id', currentUser.id);
                } else {
                    // åˆ›å»ºæ–°è®°å½•
                    await supabaseClient
                        .from('user_focus_data')
                        .insert({
                            user_id: currentUser.id,
                            focus_data: JSON.stringify(data),
                            created_at: now,
                            updated_at: now
                        });
                }

                setSyncStatus('synced');
            } catch (error) {
                console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
                setSyncStatus('error');
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ‰‹åŠ¨åŒæ­¥åˆ°äº‘ç«¯
        async function syncToCloud() {
            hideUserMenu();

            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                showLoginModal();
                return;
            }

            if (!supabaseClient) {
                console.error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                showToast('äº‘æœåŠ¡æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }

            setSyncStatus('syncing');
            showToast('æ­£åœ¨åŒæ­¥...', 'info');

            try {
                // ä¿å­˜åˆ°äº‘ç«¯
                const data = {
                    step: getCurrentStep(),
                    allGoalsList: allGoalsList,
                    top5Goals: top5Goals,
                    top3Goals: top3Goals,
                    weights: weights
                };

                const { data: existing, error: fetchError } = await supabaseClient
                    .from('user_focus_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                const now = new Date().toISOString();

                if (existing) {
                    await supabaseClient
                        .from('user_focus_data')
                        .update({
                            focus_data: JSON.stringify(data),
                            updated_at: now
                        })
                        .eq('user_id', currentUser.id);
                } else {
                    await supabaseClient
                        .from('user_focus_data')
                        .insert({
                            user_id: currentUser.id,
                            focus_data: JSON.stringify(data),
                            created_at: now,
                            updated_at: now
                        });
                }

                setSyncStatus('synced');
                showToast('åŒæ­¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.code);
                setSyncStatus('error');
                const errorMsg = error.message || 'åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                showToast(`åŒæ­¥å¤±è´¥: ${errorMsg}`, 'error');
            }
        }

        // è·å–å½“å‰æ­¥éª¤
        function getCurrentStep() {
            if (top3Goals.length === 3 && weights.reduce((a, b) => a + b, 0) === 100) return 5;
            if (top3Goals.length === 3) return 4;
            if (top5Goals.length === 5) return 3;
            if (top5Goals.length > 0) return 2;
            return allGoalsList.length > 0 ? 1 : 0;
        }

        // è®¾ç½®åŒæ­¥çŠ¶æ€
        function setSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');

            syncStatus.classList.remove('synced', 'syncing', 'error');

            switch (status) {
                case 'synced':
                    syncStatus.classList.add('synced');
                    syncText.textContent = 'å·²åŒæ­¥';
                    break;
                case 'syncing':
                    syncStatus.classList.add('syncing');
                    syncText.textContent = 'åŒæ­¥ä¸­...';
                    break;
                case 'error':
                    syncText.textContent = 'åŒæ­¥å¤±è´¥';
                    break;
                default:
                    syncText.textContent = isCloudMode ? 'å·²ç™»å½•' : 'æœ¬åœ°æ¨¡å¼';
            }
        }

        // é‡å†™ saveToStorage ä»¥æ”¯æŒäº‘ç«¯åŒæ­¥
        const originalSaveToStorage = saveToStorage;
        saveToStorage = async function(step) {
            // ä¿å­˜åˆ°æœ¬åœ°
            originalSaveToStorage(step);

            // å¦‚æœå·²ç™»å½•ï¼Œä¿å­˜åˆ°äº‘ç«¯
            if (isCloudMode && currentUser) {
                saveToCloud(step);
            }
        };

        // é¡µé¢åŠ è½½
        window.onload = async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');

            // åˆå§‹åŒ–ç§¯åˆ†ç³»ç»Ÿ
            loadPointsFromLocal();

            // åˆå§‹åŒ–Step 1æè¿°æ–‡å­—
            updateStep1Description();

            // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
            const textarea = document.getElementById('allGoals');
            if (textarea) {
                console.log('æ‰¾åˆ°è¾“å…¥æ¡†ï¼Œç»‘å®šé”®ç›˜äº‹ä»¶');
                textarea.addEventListener('keydown', handleInputKeydown);
            } else {
                console.error('æ‰¾ä¸åˆ°è¾“å…¥æ¡† allGoals');
            }

            await checkAuth();
        };
    </script>
</body>
</html>
