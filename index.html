<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026ä¸“æ³¨ - åªåšä¸‰ä»¶äº‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {Uncaught SyntaxError: Identifier 'supabase' has already been declared (at index.html:1063:13)
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-avatar:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 180px;
            overflow: hidden;
            display: none;
            z-index: 100;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-item {
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-menu-item:hover {
            background: #f0f0f0;
        }

        .user-menu-item.danger {
            color: #dc3545;
            border-top: 1px solid #eee;
        }

        /* ç™»å½•å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .login-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-modal h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #667eea;
            text-align: center;
        }

        .login-modal p {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 15px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .toggle-auth {
            text-align: center;
            font-size: 14px;
            color: #667eea;
            cursor: pointer;
            transition: opacity 0.3s;
            margin-top: 15px;
        }

        .toggle-auth:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #999;
            font-size: 13px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        .sync-status {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            gap: 5px;
            display: none;
        }

        .sync-status.show {
            display: flex;
        }

        .sync-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .sync-status.synced .dot {
            background: #28a745;
        }

        .sync-status.syncing .dot {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .demo-btn {
            background: rgba(255,255,255,0.25);
            color: white;
            border: 2px solid rgba(255,255,255,0.6);
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .demo-btn:hover {
            background: rgba(255,255,255,0.35);
            border-color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .content {
            padding: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            width: 0%;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
        }

        .step-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .tip-box {
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
            border-left: 4px solid #667eea;
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .input-area {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .goals-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 60px;
        }

        .goal-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 14px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: cardAppear 0.4s ease-out;
        }

        .goal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
        }

        .goal-card.removing {
            animation: cardDisappear 0.3s ease-out forwards;
        }

        .goal-card .icon {
            font-size: 16px;
        }

        .goal-card .remove-btn {
            opacity: 0;
            margin-left: 5px;
            cursor: pointer;
            transition: opacity 0.2s;
            color: #dc3545;
            font-weight: bold;
        }

        .goal-card:hover .remove-btn {
            opacity: 1;
        }

        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes cardDisappear {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }

        .empty-state .icon {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 16px 28px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon { color: #28a745; }
        .toast.success { border-left: 4px solid #28a745; }
        .toast.error .toast-icon { color: #dc3545; }
        .toast.error { border-left: 4px solid #dc3545; }
        .toast.info .toast-icon { color: #667eea; }
        .toast.info { border-left: 4px solid #667eea; }

        /* å¿«æ·æŒ‰é’®æç¤º */
        .quick-tip {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-top: 10px;
        }

        .goals-list {
            margin-bottom: 20px;
        }

        .goal-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .goal-item:hover {
            background: #e9ecef;
        }

        .goal-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .goal-item .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .goal-item.selected .checkbox {
            background: #667eea;
            border-color: #667eea;
        }

        .goal-item.selected .checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }

        .goal-item .text {
            flex: 1;
            font-size: 14px;
        }

        .weight-section {
            margin-bottom: 20px;
        }

        .weight-item {
            margin-bottom: 15px;
        }

        .weight-label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }

        .weight-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .weight-slider {
            width: 100%;
            margin-top: 8px;
        }

        .weight-total {
            text-align: center;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .weight-total.valid {
            background: #d4edda;
            color: #155724;
        }

        .weight-total.invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .card-preview {
            text-align: center;
            margin-bottom: 20px;
        }

        .card-preview canvas {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .download-btn {
            background: #28a745;
        }

        .download-btn:hover {
            background: #218838;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .restart-btn {
            background: #6c757d;
            margin-left: 10px;
        }

        .restart-btn:hover {
            background: #5a6268;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .selection-count {
            text-align: center;
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
        }

        .share-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .share-section h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .share-section p {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }

        .copy-link-btn {
            background: #6c757d;
            font-size: 14px;
            padding: 10px 20px;
        }

        .copy-link-btn:hover {
            background: #5a6268;
        }

        .copy-success {
            color: #28a745;
            font-size: 13px;
            margin-left: 10px;
        }

        .daily-checkin {
            text-align: center;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            margin-top: 20px;
        }

        .daily-checkin h4 {
            margin-bottom: 8px;
            color: #155724;
        }

        .daily-checkin p {
            font-size: 13px;
            color: #155724;
            margin-bottom: 10px;
        }

        .streak-count {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }

        @media (max-width: 600px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                min-height: 100vh;
                box-shadow: none;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 24px;
            }

            .user-info {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .demo-btn {
                font-size: 13px;
                padding: 8px 16px;
            }

            .login-btn {
                font-size: 13px;
                padding: 8px 16px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .content {
                padding: 20px 15px;
            }

            .step-title {
                font-size: 18px;
            }

            .step-desc {
                font-size: 13px;
            }

            .tip-box {
                font-size: 13px;
                padding: 12px 14px;
            }

            textarea {
                font-size: 15px;
                padding: 12px;
            }

            .goal-card {
                font-size: 13px;
                padding: 8px 16px;
            }

            .btn {
                width: 100%;
                font-size: 15px;
                padding: 14px;
            }

            .card-preview canvas {
                max-width: 100%;
                height: auto !important;
            }

            .daily-checkin {
                padding: 12px;
            }

            .streak-count {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="sync-status" id="syncStatus">
                <span class="dot"></span>
                <span id="syncText">æœ¬åœ°æ¨¡å¼</span>
            </div>
            <div class="user-info">
                <button class="demo-btn" onclick="startDemo()">â–¶ æ¼”ç¤º</button>
                <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()" style="display: none;">ğŸ‘¤</div>
                <button class="demo-btn" id="loginBtn" onclick="showLoginModal()">ç™»å½•</button>
            </div>
            <h1>2026ä¸“æ³¨</h1>
            <p>è¿™ä¸€å¹´ï¼Œåªåšä¸‰ä»¶äº‹</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Step 1: è¾“å…¥æ‰€æœ‰ç›®æ ‡ -->
            <div class="step active" id="step1">
                <div class="step-title">ç¬¬ä¸€æ­¥ï¼šå€’å‡ºæ‰€æœ‰ç›®æ ‡</div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šä¸è¦ç­›é€‰ï¼Œä¸è¦æ’åºï¼ŒæŠŠè„‘å­é‡Œæ‰€æœ‰æƒ³åšçš„äº‹æƒ…éƒ½å†™ä¸‹æ¥ã€‚æ¯æŒ‰ä¸€æ¬¡å›è½¦ï¼Œå°±ä¼šå˜æˆä¸€å¼ å¡ç‰‡ã€‚å†™å®Œç‚¹å‡»"æˆ‘å†™å®Œäº†"ã€‚
                </div>
                <div class="step-desc">
                    æŠŠä½ 2026å¹´æƒ³åšçš„æ‰€æœ‰äº‹æƒ…éƒ½å†™ä¸‹æ¥ï¼Œä¸é™æ•°é‡ï¼Œä¸ç”¨æ’åºã€‚è®©å¤§è„‘æ¸…ç©ºã€‚
                </div>
                <div class="input-area">
                    <textarea id="allGoals" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„ç›®æ ‡ï¼ŒæŒ‰å›è½¦é”®ç¡®è®¤..."></textarea>
                </div>
                <div class="goals-cards" id="goalsCards">
                    <div class="empty-state">
                        <span class="icon">âœ¨</span>
                        åœ¨ä¸Šé¢è¾“å…¥æ¡†ä¸­å†™ä¸‹ä½ çš„ç¬¬ä¸€ä¸ªç›®æ ‡
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 20px; color: #999; font-size: 13px;">
                    å·²è®°å½• <span id="goalCount" style="color: #667eea; font-weight: bold;">0</span> ä¸ªç›®æ ‡
                </div>
                <div style="text-align: center;">
                    <button class="btn" onclick="goToStep2()">æˆ‘å†™å®Œäº†ï¼Œä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 2: é€‰å‡º5ä¸ª -->
            <div class="step" id="step2">
                <div class="step-title">ç¬¬äºŒæ­¥ï¼šé€‰å‡ºæœ€é‡è¦çš„5ä¸ª</div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šé—®è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœ2026å¹´åªèƒ½å®Œæˆ5ä»¶äº‹ï¼Œæˆ‘ä¼šé€‰å“ª5ä¸ªï¼Ÿ
                </div>
                <div class="step-desc">
                    ä»ä½ åˆšæ‰åˆ—å‡ºçš„ç›®æ ‡ä¸­ï¼Œé€‰å‡º5ä¸ª"çœ‹èµ·æ¥å¾ˆé‡è¦"çš„ã€‚è¿™æ˜¯ç¬¬ä¸€è½®ç­›é€‰ã€‚
                </div>
                <div class="selection-count" id="step2Count">å·²é€‰æ‹© 0/5</div>
                <div class="goals-list" id="step2List"></div>
                <div class="error-message" id="step2Error"></div>
                <button class="btn" onclick="goToStep3()">ä¸‹ä¸€æ­¥</button>
            </div>

            <!-- Step 3: é€‰å‡º3ä¸ª -->
            <div class="step" id="step3">
                <div class="step-title">ç¬¬ä¸‰æ­¥ï¼šæœ€ç»ˆé€‰å‡º3ä¸ª</div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šè¿™å¯èƒ½æ˜¯æœ€ç—›è‹¦çš„ä¸€æ­¥ã€‚é—®è‡ªå·±ï¼šå“ª3ä¸ªç›®æ ‡å®ç°åï¼Œä¼šè®©2026å¹´æ— æ†¾ï¼Ÿ
                </div>
                <div class="step-desc">
                    ä»è¿™5ä¸ªç›®æ ‡ä¸­ï¼Œåªä¿ç•™3ä¸ªã€‚è¿™æ˜¯æ®‹é…·ä½†å¿…è¦çš„ä¸€æ­¥ï¼Œå…¶ä»–çš„åªèƒ½æ”¾å¼ƒã€‚
                </div>
                <div class="selection-count" id="step3Count">å·²é€‰æ‹© 0/3</div>
                <div class="goals-list" id="step3List"></div>
                <div class="error-message" id="step3Error"></div>
                <button class="btn" onclick="goToStep4()">ä¸‹ä¸€æ­¥</button>
            </div>

            <!-- Step 4: åˆ†é…æƒé‡ -->
            <div class="step" id="step4">
                <div class="step-title">ç¬¬å››æ­¥ï¼šåˆ†é…æƒé‡</div>
                <div class="tip-box">
                    ğŸ’¡ æç¤ºï¼šæƒé‡ä»£è¡¨ä½ çš„ç²¾åŠ›åˆ†é…ã€‚50%çš„ç›®æ ‡è¦æŠ•å…¥ä¸€åŠçš„æ—¶é—´å’Œæ³¨æ„åŠ›ã€‚
                </div>
                <div class="step-desc">
                    ç»™è¿™3ä¸ªç›®æ ‡åˆ†é…æƒé‡ï¼Œæ€»å’Œå¿…é¡»æ˜¯100%ã€‚
                </div>
                <div class="weight-section" id="weightSection"></div>
                <div class="weight-total" id="weightTotal">
                    å½“å‰æ€»å’Œï¼š0%
                </div>
                <div class="error-message" id="step4Error"></div>
                <button class="btn" onclick="generateCard()">ç”Ÿæˆä¸“æ³¨å¡</button>
            </div>

            <!-- Step 5: ç”Ÿæˆä¸“æ³¨å¡ -->
            <div class="step" id="step5">
                <div class="step-title">ä½ çš„2026ä¸“æ³¨å¡</div>
                <div class="step-desc">
                    æŠŠè¿™å¼ å¡ä¿å­˜ä¸ºæ‰‹æœºå£çº¸ï¼Œæ¯å¤©æé†’è‡ªå·±ï¼šåªåšè¿™ä¸‰ä»¶äº‹ã€‚
                </div>
                <div class="card-preview">
                    <canvas id="focusCard"></canvas>
                </div>
                <div style="text-align: center;">
                    <button class="btn download-btn" onclick="downloadCard()">ä¸‹è½½ä¸“æ³¨å¡</button>
                </div>

                <div class="daily-checkin" id="dailyCheckin">
                    <h4>ğŸ”¥ å·²è¿ç»­ä¸“æ³¨ <span class="streak-count" id="streakCount">0</span> å¤©</h4>
                    <p>æ¯å¤©å›æ¥æ‰“å¡ï¼Œä¿æŒä¸“æ³¨æƒ¯æ€§</p>
                    <button class="btn" onclick="dailyCheckin()" id="checkinBtn">ä»Šæ—¥æ‰“å¡</button>
                </div>

                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 13px; color: #666;">
                    <p style="margin-bottom: 8px;">ğŸ’¡ å°æç¤ºï¼šæŠŠè¿™å¼ ä¸“æ³¨å¡è®¾ä¸ºæ‰‹æœºå£çº¸</p>
                    <p>æ¯å¤©çå¼€çœ¼å°±èƒ½çœ‹åˆ°ï¼Œæ—¶åˆ»æé†’è‡ªå·±</p>
                </div>

                <div class="share-section">
                    <h4>ğŸ“¤ åˆ†äº«ç»™ä½ çš„æœ‹å‹</h4>
                    <p>è®©æ›´å¤šäººç”¨å‡æ³•æ€ç»´è§„åˆ’2026</p>
                    <button class="btn copy-link-btn" onclick="copyShareLink()">å¤åˆ¶é“¾æ¥</button>
                    <span class="copy-success" id="copySuccess" style="display: none;">âœ“ å·²å¤åˆ¶</span>
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn restart-btn" onclick="restart()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·èœå• -->
    <div class="user-menu" id="userMenu">
        <div class="user-menu-item" onclick="syncToCloud()">
            <span>â˜ï¸</span>
            <span id="syncMenuItem">ç«‹å³åŒæ­¥</span>
        </div>
        <div class="user-menu-item" onclick="viewProfile()">
            <span>ğŸ‘¤</span>
            <span>ä¸ªäººèµ„æ–™</span>
        </div>
        <div class="user-menu-item danger" onclick="logout()">
            <span>ğŸšª</span>
            <span>é€€å‡ºç™»å½•</span>
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div class="modal-overlay" id="loginModal">
        <div class="login-modal" style="position: relative;">
            <button class="close-modal" onclick="hideLoginModal()">Ã—</button>

            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm">
                <h2>æ¬¢è¿å›æ¥</h2>
                <p>ç™»å½•åè‡ªåŠ¨åŒæ­¥ä½ çš„ä¸“æ³¨ç›®æ ‡</p>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="login-btn" onclick="handleLogin()" id="loginSubmitBtn">ç™»å½•</button>

                <div class="auth-divider">æˆ–</div>

                <button class="login-btn" style="background: #24292e;" onclick="handleGuestLogin()">
                    <span style="font-size: 16px;">ğŸ‘¤</span>
                    <span style="margin-left: 8px;">æ¸¸å®¢æ¨¡å¼ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰</span>
                </button>

                <div class="toggle-auth" onclick="showRegisterForm()">æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</div>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #999;">
                    <a href="#" onclick="showForgotPassword()" style="color: #667eea;">å¿˜è®°å¯†ç ï¼Ÿ</a>
                </div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerForm" style="display: none;">
                <h2>åˆ›å»ºè´¦å·</h2>
                <p>æ³¨å†Œåè‡ªåŠ¨äº‘ç«¯ä¿å­˜ä½ çš„ä¸“æ³¨ç›®æ ‡</p>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰</label>
                    <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" id="registerConfirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-start; gap: 8px;">
                    <input type="checkbox" id="agreeTerms" style="margin-top: 3px;">
                    <label for="agreeTerms" style="font-size: 13px; color: #666; cursor: pointer;">
                        æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#" style="color: #667eea; text-decoration: none;" onclick="event.preventDefault(); alert('æœåŠ¡æ¡æ¬¾å†…å®¹...');">æœåŠ¡æ¡æ¬¾</a>
                    </label>
                </div>
                <button class="login-btn" onclick="handleRegister()" id="registerSubmitBtn">æ³¨å†Œ</button>
                <div class="toggle-auth" onclick="showLoginForm()">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</div>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">âœ“</span>
        <span id="toastMessage">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://klywwizwconvwjifzrcw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_65tNpTMzDgY8PFEQxIS-Eg_0tXESrkV';

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        let supabaseClient = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.log('Supabase åº“æœªåŠ è½½');
            }
        } catch (e) {
            console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', e);
        }

        // æ•°æ®å­˜å‚¨
        let allGoalsList = [];
        let top5Goals = [];
        let top3Goals = [];
        let weights = [0, 0, 0];
        let isDemoRunning = false;
        let audioContext = null;
        let currentUser = null;
        let isCloudMode = false;

        // ===== å…¨å±€å‡½æ•°å®šä¹‰ï¼ˆç¡®ä¿åœ¨æ‰€æœ‰ä½ç½®éƒ½å¯ç”¨ï¼‰=====

        // å¤„ç†è¾“å…¥æ¡†æŒ‰é”®
        function handleInputKeydown(event) {
            console.log('é”®ç›˜äº‹ä»¶è§¦å‘:', event.key, event.code, event.keyCode);
            if (event.key === 'Enter' && !event.shiftKey) {
                console.log('æ£€æµ‹åˆ°Enteré”®ï¼Œå‡†å¤‡æ·»åŠ ç›®æ ‡');
                event.preventDefault();
                const textarea = document.getElementById('allGoals');
                const text = textarea.value.trim();

                console.log('è¾“å…¥å†…å®¹:', text);
                if (text.length > 0) {
                    console.log('è°ƒç”¨ addGoalCard');
                    addGoalCard(text);
                    textarea.value = '';
                    textarea.focus();
                }
            }
        }

        // ===== éŸ³æ•ˆç³»ç»Ÿ =====
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // æ‰“å­—éŸ³æ•ˆ - æ¸…è„†çš„æ°”æ³¡å£°
        function playTypingSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800 + Math.random() * 200, audioContext.currentTime);
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // å¡ç‰‡å‡ºç°éŸ³æ•ˆ - æŸ”å’Œçš„ç¡®è®¤å£°
        function playCardSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.exponentialRampToValueAtTime(783.99, audioContext.currentTime + 0.1); // G5
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // é‡Šæ”¾éŸ³æ•ˆ - èˆ’ç¼“çš„å’Œå¼¦
        function playReleaseSound() {
            initAudio();
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6

            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.05);
                oscillator.type = 'sine';

                const startTime = audioContext.currentTime + index * 0.05;
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.1, startTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 1.5);

                oscillator.start(startTime);
                oscillator.stop(startTime + 1.5);
            });
        }

        // æ¸²æŸ“ç›®æ ‡å¡ç‰‡
        // æ·»åŠ ç›®æ ‡å¡ç‰‡
        function addGoalCard(text) {
            console.log('addGoalCard è¢«è°ƒç”¨:', text);
            playCardSound();

            const icons = ['ğŸ¯', 'ğŸ’ª', 'ğŸ“š', 'ğŸƒ', 'ğŸ’¼', 'ğŸš€', 'âœ¨', 'ğŸŒŸ', 'ğŸ”¥', 'ğŸ’'];
            const randomIcon = icons[Math.floor(Math.random() * icons.length)];

            const goal = {
                id: Date.now() + Math.random(),
                text: text,
                icon: randomIcon,
                selected: false
            };

            console.log('æ·»åŠ ç›®æ ‡:', goal);
            allGoalsList.push(goal);
            console.log('å½“å‰ç›®æ ‡åˆ—è¡¨é•¿åº¦:', allGoalsList.length);
            renderGoalCards();
            updateGoalCount();
            console.log('addGoalCard æ‰§è¡Œå®Œæˆ');
        }

        function renderGoalCards() {
            const container = document.getElementById('goalsCards');

            if (allGoalsList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">âœ¨</span>
                        åœ¨ä¸Šé¢è¾“å…¥æ¡†ä¸­å†™ä¸‹ä½ çš„ç¬¬ä¸€ä¸ªç›®æ ‡
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            allGoalsList.forEach((goal, index) => {
                const card = document.createElement('div');
                card.className = 'goal-card';
                card.style.animationDelay = `${index * 0.05}s`;
                card.innerHTML = `
                    <span class="icon">${goal.icon}</span>
                    <span class="text">${escapeHtml(goal.text)}</span>
                    <span class="remove-btn" onclick="removeGoalCard(${index})">âœ•</span>
                `;
                container.appendChild(card);
            });
        }

        // åˆ é™¤ç›®æ ‡å¡ç‰‡
        function removeGoalCard(index) {
            const cards = document.querySelectorAll('.goal-card');
            if (cards[index]) {
                cards[index].classList.add('removing');
                setTimeout(() => {
                    allGoalsList.splice(index, 1);
                    renderGoalCards();
                    updateGoalCount();
                }, 300);
            }
        }

        // æ›´æ–°ç›®æ ‡è®¡æ•°
        function updateGoalCount() {
            document.getElementById('goalCount').textContent = allGoalsList.length;
        }
        function loadFromStorage() {
            const saved = localStorage.getItem('focus2026_data');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.step) {
                    allGoalsList = data.allGoalsList || [];
                    top5Goals = data.top5Goals || [];
                    top3Goals = data.top3Goals || [];
                    weights = data.weights || [0, 0, 0];

                    // æ¢å¤åˆ°å¯¹åº”æ­¥éª¤
                    if (data.step >= 1) {
                        goToStep(1);
                        updateProgress(20);
                        renderGoalCards();
                        updateGoalCount();
                    }
                    if (data.step >= 2) {
                        goToStep(2);
                        updateProgress(40);
                        renderStep2List();
                    }
                    if (data.step >= 3) {
                        goToStep(3);
                        updateProgress(60);
                        renderStep3List();
                    }
                    if (data.step >= 4) {
                        goToStep(4);
                        updateProgress(80);
                        renderWeightSection();
                    }
                    if (data.step >= 5) {
                        goToStep(5);
                        updateProgress(100);
                        generateCard();
                        loadStreakData();
                    }
                }
            } else {
                updateProgress(20);
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToStorage(step) {
            const data = {
                step: step,
                allGoalsList: allGoalsList,
                top5Goals: top5Goals,
                top3Goals: top3Goals,
                weights: weights
            };
            localStorage.setItem('focus2026_data', JSON.stringify(data));
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // åˆ‡æ¢æ­¥éª¤
        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + stepNum).classList.add('active');
        }

        // Toast æç¤ºå‡½æ•°
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            toast.className = 'toast ' + type;
            msg.textContent = message;

            if (type === 'success') icon.textContent = 'âœ“';
            else if (type === 'error') icon.textContent = 'âœ•';
            else icon.textContent = 'â„¹';

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Step 1 -> Step 2
        function goToStep2() {
            if (allGoalsList.length === 0) {
                showToast('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç›®æ ‡', 'error');
                return;
            }

            playReleaseSound();

            saveToStorage(1);
            goToStep(2);
            updateProgress(40);
            renderStep2List();

            // å¦‚æœæ˜¯æ¼”ç¤ºæ¨¡å¼ï¼Œç»§ç»­åç»­æ­¥éª¤
            if (isDemoRunning && window.demoStep2) {
                window.demoStep2();
            }
        }

        // æ¸²æŸ“Step 2åˆ—è¡¨
        function renderStep2List() {
            const container = document.getElementById('step2List');
            container.innerHTML = '';

            allGoalsList.forEach(goal => {
                const item = document.createElement('div');
                item.className = 'goal-item' + (goal.selected ? ' selected' : '');
                item.onclick = () => toggleStep2Goal(goal.id);
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="text">${escapeHtml(goal.text)}</div>
                `;
                container.appendChild(item);
            });

            updateStep2Count();
        }

        // åˆ‡æ¢Step 2é€‰ä¸­çŠ¶æ€
        function toggleStep2Goal(id) {
            if (isDemoRunning) return;

            const goal = allGoalsList.find(g => g.id === id);
            if (goal) {
                const selectedCount = allGoalsList.filter(g => g.selected).length;
                if (!goal.selected && selectedCount >= 5) {
                    return;
                }
                goal.selected = !goal.selected;
                renderStep2List();
            }
        }

        // æ›´æ–°Step 2é€‰æ‹©è®¡æ•°
        function updateStep2Count() {
            const count = allGoalsList.filter(g => g.selected).length;
            document.getElementById('step2Count').textContent = `å·²é€‰æ‹© ${count}/5`;
        }

        // Step 2 -> Step 3
        function goToStep3() {
            const selected = allGoalsList.filter(g => g.selected);
            if (selected.length !== 5) {
                document.getElementById('step2Error').textContent = 'è¯·æ­£å¥½é€‰æ‹©5ä¸ªç›®æ ‡';
                return;
            }
            document.getElementById('step2Error').textContent = '';

            top5Goals = selected.map(g => ({ ...g, selected: false }));
            saveToStorage(2);
            goToStep(3);
            updateProgress(60);
            renderStep3List();
        }

        // æ¸²æŸ“Step 3åˆ—è¡¨
        function renderStep3List() {
            const container = document.getElementById('step3List');
            container.innerHTML = '';

            top5Goals.forEach(goal => {
                const item = document.createElement('div');
                item.className = 'goal-item' + (goal.selected ? ' selected' : '');
                item.onclick = () => toggleStep3Goal(goal.id);
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="text">${escapeHtml(goal.text)}</div>
                `;
                container.appendChild(item);
            });

            updateStep3Count();
        }

        // åˆ‡æ¢Step 3é€‰ä¸­çŠ¶æ€
        function toggleStep3Goal(id) {
            if (isDemoRunning) return;

            const goal = top5Goals.find(g => g.id === id);
            if (goal) {
                const selectedCount = top5Goals.filter(g => g.selected).length;
                if (!goal.selected && selectedCount >= 3) {
                    return;
                }
                goal.selected = !goal.selected;
                renderStep3List();
            }
        }

        // æ›´æ–°Step 3é€‰æ‹©è®¡æ•°
        function updateStep3Count() {
            const count = top5Goals.filter(g => g.selected).length;
            document.getElementById('step3Count').textContent = `å·²é€‰æ‹© ${count}/3`;
        }

        // Step 3 -> Step 4
        function goToStep4() {
            const selected = top5Goals.filter(g => g.selected);
            if (selected.length !== 3) {
                document.getElementById('step3Error').textContent = 'è¯·æ­£å¥½é€‰æ‹©3ä¸ªç›®æ ‡';
                return;
            }
            document.getElementById('step3Error').textContent = '';

            top3Goals = selected.map((g, index) => ({ ...g, weight: 0 }));
            weights = [0, 0, 0];
            saveToStorage(3);
            goToStep(4);
            updateProgress(80);
            renderWeightSection();
        }

        // æ¸²æŸ“æƒé‡åˆ†é…åŒºåŸŸ
        function renderWeightSection() {
            const container = document.getElementById('weightSection');
            container.innerHTML = '';

            top3Goals.forEach((goal, index) => {
                const item = document.createElement('div');
                item.className = 'weight-item';
                item.innerHTML = `
                    <div class="weight-label">${escapeHtml(goal.text)}</div>
                    <input type="range" class="weight-slider" min="0" max="100" value="${weights[index]}"
                        oninput="updateWeight(${index}, this.value)">
                    <div style="text-align: center; margin-top: 5px; font-weight: bold; color: #667eea;">
                        ${weights[index]}%
                    </div>
                `;
                container.appendChild(item);
            });

            updateWeightTotal();
        }

        // æ›´æ–°æƒé‡
        function updateWeight(index, value) {
            if (isDemoRunning) return;

            weights[index] = parseInt(value);
            renderWeightSection();
            updateWeightTotal();
        }

        // æ›´æ–°æƒé‡æ€»å’Œæ˜¾ç¤º
        function updateWeightTotal() {
            const total = weights.reduce((a, b) => a + b, 0);
            const totalEl = document.getElementById('weightTotal');
            totalEl.textContent = `å½“å‰æ€»å’Œï¼š${total}%`;

            if (total === 100) {
                totalEl.className = 'weight-total valid';
                document.getElementById('step4Error').textContent = '';
            } else {
                totalEl.className = 'weight-total invalid';
                document.getElementById('step4Error').textContent = 'æƒé‡æ€»å’Œå¿…é¡»æ˜¯100%';
            }
        }

        // Step 4 -> Step 5: ç”Ÿæˆä¸“æ³¨å¡
        function generateCard() {
            const total = weights.reduce((a, b) => a + b, 0);
            if (total !== 100) {
                showToast('æƒé‡æ€»å’Œå¿…é¡»æ˜¯100%', 'error');
                return;
            }

            saveToStorage(4);
            goToStep(5);
            updateProgress(100);

            // ç»˜åˆ¶Canvas
            const canvas = document.getElementById('focusCard');
            const ctx = canvas.getContext('2d');

            canvas.width = 1080;
            canvas.height = 1920;

            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.beginPath();
            ctx.arc(canvas.width * 0.8, canvas.height * 0.2, 300, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath();
            ctx.arc(canvas.width * 0.2, canvas.height * 0.8, 200, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'white';
            ctx.font = 'bold 80px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('2026', canvas.width / 2, 200);

            ctx.font = 'bold 60px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
            ctx.fillText('è¿™ä¸€å¹´ï¼Œåªåšä¸‰ä»¶äº‹', canvas.width / 2, 300);

            const startY = 500;
            const gap = 400;

            top3Goals.forEach((goal, index) => {
                const y = startY + index * gap;

                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.beginPath();
                ctx.roundRect(80, y, canvas.width - 160, 320, 20);
                ctx.fill();

                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 50px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`${weights[index]}%`, 120, y + 80);

                ctx.fillStyle = '#333';
                ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
                ctx.textAlign = 'left';

                const text = goal.text;
                const maxWidth = canvas.width - 240;
                const lineHeight = 70;
                const words = text.split('');
                let line = '';
                let lineCount = 0;
                const maxLines = 3;

                for (let i = 0; i < words.length && lineCount < maxLines; i++) {
                    const testLine = line + words[i];
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && line.length > 0) {
                        ctx.fillText(line, 120, y + 160 + lineCount * lineHeight);
                        line = words[i];
                        lineCount++;
                    } else {
                        line = testLine;
                    }
                }
                if (line.length > 0 && lineCount < maxLines) {
                    ctx.fillText(line, 120, y + 160 + lineCount * lineHeight);
                }
            });

            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '36px -apple-system, BlinkMacSystemFont, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('å…¶ä»–çš„ï¼Œè®©å®ƒä»¬å»å§', canvas.width / 2, canvas.height - 100);

            saveToStorage(5);
            loadStreakData();
        }

        // ä¸‹è½½ä¸“æ³¨å¡
        function downloadCard() {
            const canvas = document.getElementById('focusCard');
            const link = document.createElement('a');
            link.download = '2026ä¸“æ³¨å¡.png';
            link.href = canvas.toDataURL('image/png');
            link.click();

            showToast('ä¸“æ³¨å¡å·²ä¸‹è½½ï¼Œè®¾ä¸ºå£çº¸å§ï¼', 'success');
        }

        // é‡æ–°å¼€å§‹
        function restart() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è¿›åº¦å°†è¢«æ¸…é™¤ã€‚')) {
                localStorage.removeItem('focus2026_data');
                localStorage.removeItem('focus2026_streak');
                location.reload();
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== æ¼”ç¤ºæ¨¡å¼ =====
        function startDemo() {
            isDemoRunning = true;
            localStorage.removeItem('focus2026_data');
            localStorage.removeItem('focus2026_streak');
            allGoalsList = [];
            top5Goals = [];
            top3Goals = [];

            const demoGoals = [
                'å­©å­ä¸­è€ƒè€ƒä¸Šå¥½é«˜ä¸­',
                'é˜…è¯»52æœ¬ä¹¦',
                'è·‘å®Œ1000å…¬é‡Œä¿æŒå¥åº·',
                'ç”¨AIåˆ›ä¸š',
                'åšå†…å®¹åˆ›ä¸š',
                'å­¦ä¹ Pythonç¼–ç¨‹',
                'æ¯å‘¨å†™3ç¯‡æ–‡ç« ',
                'å­¦ä¼šé’¢ç´åŸºç¡€'
            ];

            // Step 1: æ¸…ç©ºå¹¶å›åˆ°ç¬¬ä¸€æ­¥
            goToStep(1);
            updateProgress(20);
            document.getElementById('allGoals').value = '';
            renderGoalCards();
            updateGoalCount();

            // é€ä¸ªæ·»åŠ ç›®æ ‡å¡ç‰‡
            let goalIndex = 0;
            function addNextGoal() {
                if (goalIndex < demoGoals.length) {
                    const textarea = document.getElementById('allGoals');
                    textarea.value = demoGoals[goalIndex];
                    addGoalCard(demoGoals[goalIndex]);
                    textarea.value = '';
                    goalIndex++;
                    setTimeout(addNextGoal, 400); // æ¯0.4ç§’æ·»åŠ ä¸€ä¸ª
                } else {
                    // æ‰€æœ‰ç›®æ ‡æ·»åŠ å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
                    setTimeout(() => {
                        playReleaseSound();
                        goToStep2();
                    }, 500);
                }
            }

            setTimeout(addNextGoal, 500); // å¼€å§‹æ·»åŠ ç›®æ ‡

            // é‡æ–°å®šä¹‰ Step 2-5 çš„æ¼”ç¤ºé€»è¾‘ï¼ˆåœ¨ addNextGoal å®Œæˆåæ‰§è¡Œï¼‰
            window.demoStep2 = function() {
                allGoalsList = demoGoals.map((text, i) => ({
                    id: i,
                    text,
                    icon: ['ğŸ¯', 'ğŸ’ª', 'ğŸ“š', 'ğŸƒ', 'ğŸ’¼', 'ğŸš€', 'âœ¨', 'ğŸŒŸ'][i % 8],
                    selected: false
                }));
                renderStep2List();

                // Step 2: é€‰5ä¸ª
                setTimeout(() => {
                    const toSelect = [0, 1, 2, 3, 4];
                    toSelect.forEach((id, idx) => {
                        setTimeout(() => {
                            allGoalsList[id].selected = true;
                            renderStep2List();
                        }, idx * 300);
                    });

                    setTimeout(() => {
                        goToStep3();
                        top5Goals = allGoalsList.filter(g => g.selected).map(g => ({ ...g, selected: false }));
                        renderStep3List();

                        // Step 3: é€‰3ä¸ª
                        setTimeout(() => {
                            const toSelect3 = [0, 1, 2];
                            toSelect3.forEach((relativeId, idx) => {
                                setTimeout(() => {
                                    top5Goals[relativeId].selected = true;
                                    renderStep3List();
                                }, idx * 300);
                            });

                            setTimeout(() => {
                                goToStep4();
                                top3Goals = top5Goals.filter(g => g.selected).map((g, i) => ({ ...g, weight: 0 }));
                                renderWeightSection();

                                // Step 4: åˆ†é…æƒé‡
                                setTimeout(() => {
                                    weights = [50, 30, 20];
                                    renderWeightSection();
                                    updateWeightTotal();

                                    setTimeout(() => {
                                        generateCard();

                                    setTimeout(() => {
                                        isDemoRunning = false;
                                        localStorage.removeItem('focus2026_data');
                                        localStorage.removeItem('focus2026_streak');
                                        showToast('æ¼”ç¤ºå®Œæˆï¼ç°åœ¨è½®åˆ°ä½ äº†', 'success');
                                    }, 2000);
                                    }, 1000);
                                }, 1000);
                            }, 1500);
                        }, 2000);
                    }, 2000);
                }, 1500);
            };
        }

        // ===== ç”¨æˆ·ç•™å­˜åŠŸèƒ½ =====

        // åŠ è½½æ‰“å¡æ•°æ®
        function loadStreakData() {
            const streakData = JSON.parse(localStorage.getItem('focus2026_streak') || '{"streak": 0, "lastDate": null}');
            const today = new Date().toDateString();
            const lastDate = streakData.lastDate;

            // æ£€æŸ¥æ˜¯å¦è¿ç»­
            if (lastDate) {
                const last = new Date(lastDate);
                const now = new Date(today);
                const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));

                if (diffDays > 1) {
                    // æ–­äº†ï¼Œé‡ç½®
                    streakData.streak = 0;
                }
            }

            document.getElementById('streakCount').textContent = streakData.streak;

            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡
            if (lastDate === today) {
                document.getElementById('checkinBtn').disabled = true;
                document.getElementById('checkinBtn').textContent = 'âœ“ å·²æ‰“å¡';
            }
        }

        // æ¯æ—¥æ‰“å¡
        function dailyCheckin() {
            const streakData = JSON.parse(localStorage.getItem('focus2026_streak') || '{"streak": 0, "lastDate": null}');
            const today = new Date().toDateString();

            if (streakData.lastDate === today) {
                return;
            }

            streakData.streak++;
            streakData.lastDate = today;
            localStorage.setItem('focus2026_streak', JSON.stringify(streakData));

            document.getElementById('streakCount').textContent = streakData.streak;
            document.getElementById('checkinBtn').disabled = true;
            document.getElementById('checkinBtn').textContent = 'âœ“ å·²æ‰“å¡';

            // æ‰“å¡å¥–åŠ±æç¤º
            const messages = [
                'å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼',
                'ä¸“æ³¨åŠ›+1ï¼',
                'ä½ æ¯”æ˜¨å¤©æ›´è¿›ä¸€æ­¥ï¼',
                'è¿ç»­æ‰“å¡å°±æ˜¯èƒœåˆ©ï¼',
                'æ¯ä¸€ä»½åšæŒéƒ½ç®—æ•°ï¼'
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            showToast(randomMsg, 'success');
        }

        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            const url = 'https://sangzhexianxian.github.io/focus/';

            // ä¼˜å…ˆä½¿ç”¨ç°ä»£ API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(shareText);
            }
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                // æœ€åçš„ä¿åº•æ–¹æ¡ˆï¼šprompt
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼š', text);
            }

            document.body.removeChild(textarea);
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopySuccess() {
            const success = document.getElementById('copySuccess');
            success.style.display = 'inline';
            setTimeout(() => {
                success.style.display = 'none';
            }, 3000);
        }

        // ===== ç”¨æˆ·è®¤è¯ç›¸å…³ =====

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            if (!supabaseClient) {
                console.log('Supabase æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                currentUser = null;
                isCloudMode = false;
                updateUserUI(false);
                loadFromStorage();
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('è·å–ä¼šè¯å¤±è´¥:', error);
                    throw error;
                }

                if (session) {
                    currentUser = session.user;
                    isCloudMode = true;
                    updateUserUI(true);
                    await loadFromCloud();
                } else {
                    currentUser = null;
                    isCloudMode = false;
                    updateUserUI(false);
                    loadFromStorage();
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                currentUser = null;
                isCloudMode = false;
                updateUserUI(false);
                loadFromStorage();
            }
        }

        // æ˜¾ç¤ºç™»å½•å¼¹çª—
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            showLoginForm();
        }

        // éšè—ç™»å½•å¼¹çª—
        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        // æ¸¸å®¢æ¨¡å¼ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
        function handleGuestLogin() {
            currentUser = null;
            isCloudMode = false;
            updateUserUI(false);
            hideLoginModal();
            showToast('å·²è¿›å…¥æ¸¸å®¢æ¨¡å¼ï¼Œæ•°æ®ä¿å­˜åœ¨æœ¬åœ°', 'info');
            loadFromStorage();
        }

        // å¿˜è®°å¯†ç 
        function showForgotPassword() {
            event.preventDefault();
            const email = prompt('è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼Œæˆ‘ä»¬å°†å‘é€å¯†ç é‡ç½®é“¾æ¥ï¼š');

            if (email && email.trim()) {
                if (!supabaseClient) {
                    showToast('äº‘ç«¯æœåŠ¡æœªåˆå§‹åŒ–', 'error');
                    return;
                }

                // è¿™é‡Œå¯ä»¥è°ƒç”¨ Supabase çš„å¯†ç é‡ç½®åŠŸèƒ½
                showToast('å¯†ç é‡ç½®é“¾æ¥å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±', 'info');
            }
        }

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // å¤„ç†ç™»å½•
        async function handleLogin() {
            if (!supabaseClient) {
                showToast('äº‘ç«¯æœåŠ¡æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginSubmitBtn');

            if (!email || !password) {
                showToast('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    console.error('ç™»å½•é”™è¯¯:', error);
                    throw error;
                }

                currentUser = data.user;
                isCloudMode = true;
                updateUserUI(true);
                hideLoginModal();
                showToast('ç™»å½•æˆåŠŸï¼', 'success');
                await loadFromCloud();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                const errorMsg = error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ';
                showToast(errorMsg, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™»å½•';
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister() {
            if (!supabaseClient) {
                showToast('äº‘ç«¯æœåŠ¡æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return;
            }

            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const btn = document.getElementById('registerSubmitBtn');

            if (!email || !password) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            // é‚®ç®±æ ¼å¼éªŒè¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            if (!agreeTerms) {
                showToast('è¯·å…ˆé˜…è¯»å¹¶åŒæ„æœåŠ¡æ¡æ¬¾', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æ³¨å†Œä¸­...';

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: window.location.href
                    }
                });

                if (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error);

                    // ç‰¹æ®Šé”™è¯¯å¤„ç†
                    if (error.message.includes('User already registered')) {
                        showToast('è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•', 'error');
                    } else {
                        throw error;
                    }
                    return;
                }

                showToast('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ç¡®è®¤è´¦å·', 'success');
                showLoginForm();
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                const errorMsg = error.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                showToast(errorMsg, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ³¨å†Œ';
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿæœ¬åœ°æ•°æ®å°†ä¸ä¼šåˆ é™¤ã€‚')) return;

            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }

            currentUser = null;
            isCloudMode = false;
            updateUserUI(false);
            loadFromStorage();
            hideUserMenu();
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        }

        // æ›´æ–°ç”¨æˆ·UI
        function updateUserUI(isLoggedIn) {
            const userAvatar = document.getElementById('userAvatar');
            const loginBtn = document.getElementById('loginBtn');
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');

            if (isLoggedIn && currentUser) {
                userAvatar.style.display = 'flex';
                userAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
                loginBtn.style.display = 'none';
                syncStatus.classList.add('show', 'synced');
                syncText.textContent = 'å·²ç™»å½•';
            } else {
                userAvatar.style.display = 'none';
                loginBtn.style.display = 'inline-block';
                syncStatus.classList.remove('show', 'synced');
                syncText.textContent = 'æœ¬åœ°æ¨¡å¼';
            }
        }

        // åˆ‡æ¢ç”¨æˆ·èœå•
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');

            // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.user-info')) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // éšè—ç”¨æˆ·èœå•
        function hideUserMenu() {
            document.getElementById('userMenu').classList.remove('show');
        }

        // æŸ¥çœ‹ä¸ªäººèµ„æ–™
        function viewProfile() {
            hideUserMenu();
            if (currentUser) {
                alert(`é‚®ç®±ï¼š${currentUser.email}\nåˆ›å»ºæ—¶é—´ï¼š${new Date(currentUser.created_at).toLocaleDateString()}`);
            }
        }

        // ===== äº‘ç«¯åŒæ­¥ç›¸å…³ =====

        // ä»äº‘ç«¯åŠ è½½æ•°æ®
        async function loadFromCloud() {
            if (!currentUser || !supabaseClient) return;

            setSyncStatus('syncing');

            try {
                const { data, error } = await supabaseClient
                    .from('user_focus_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('æŸ¥è¯¢äº‘ç«¯æ•°æ®å¤±è´¥:', error);
                    throw error;
                }

                if (data && data.focus_data) {
                    const savedData = JSON.parse(data.focus_data);
                    if (savedData.step) {
                        allGoalsList = savedData.allGoalsList || [];
                        top5Goals = savedData.top5Goals || [];
                        top3Goals = savedData.top3Goals || [];
                        weights = savedData.weights || [0, 0, 0];

                        // æ¢å¤åˆ°å¯¹åº”æ­¥éª¤
                        if (savedData.step >= 1) {
                            goToStep(1);
                            updateProgress(20);
                            renderGoalCards();
                            updateGoalCount();
                        }
                        if (savedData.step >= 2) {
                            goToStep(2);
                            updateProgress(40);
                            renderStep2List();
                        }
                        if (savedData.step >= 3) {
                            goToStep(3);
                            updateProgress(60);
                            renderStep3List();
                        }
                        if (savedData.step >= 4) {
                            goToStep(4);
                            updateProgress(80);
                            renderWeightSection();
                        }
                        if (savedData.step >= 5) {
                            goToStep(5);
                            updateProgress(100);
                            generateCard();
                        }

                        setSyncStatus('synced');
                        showToast('æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥', 'info');
                    }
                } else {
                    loadFromStorage();
                }
            } catch (error) {
                console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error);
                setSyncStatus('error');
                showToast('åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                loadFromStorage();
            }
        }

        // ä¿å­˜åˆ°äº‘ç«¯
        async function saveToCloud(step) {
            if (!currentUser || !supabaseClient) return;

            const data = {
                step: step,
                allGoalsList: allGoalsList,
                top5Goals: top5Goals,
                top3Goals: top3Goals,
                weights: weights
            };

            setSyncStatus('syncing');

            try {
                const { data: existing, error: fetchError } = await supabaseClient
                    .from('user_focus_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;

                const now = new Date().toISOString();

                if (existing) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    await supabaseClient
                        .from('user_focus_data')
                        .update({
                            focus_data: JSON.stringify(data),
                            updated_at: now
                        })
                        .eq('user_id', currentUser.id);
                } else {
                    // åˆ›å»ºæ–°è®°å½•
                    await supabaseClient
                        .from('user_focus_data')
                        .insert({
                            user_id: currentUser.id,
                            focus_data: JSON.stringify(data),
                            created_at: now,
                            updated_at: now
                        });
                }

                setSyncStatus('synced');
            } catch (error) {
                console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
                setSyncStatus('error');
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ‰‹åŠ¨åŒæ­¥åˆ°äº‘ç«¯
        async function syncToCloud() {
            hideUserMenu();

            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                showLoginModal();
                return;
            }

            setSyncStatus('syncing');
            showToast('æ­£åœ¨åŒæ­¥...', 'info');

            try {
                // ä¿å­˜åˆ°äº‘ç«¯
                const data = {
                    step: getCurrentStep(),
                    allGoalsList: allGoalsList,
                    top5Goals: top5Goals,
                    top3Goals: top3Goals,
                    weights: weights
                };

                const { data: existing, error: fetchError } = await supabase
                    .from('user_focus_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                const now = new Date().toISOString();

                if (existing) {
                    await supabase
                        .from('user_focus_data')
                        .update({
                            focus_data: JSON.stringify(data),
                            updated_at: now
                        })
                        .eq('user_id', currentUser.id);
                } else {
                    await supabase
                        .from('user_focus_data')
                        .insert({
                            user_id: currentUser.id,
                            focus_data: JSON.stringify(data),
                            created_at: now,
                            updated_at: now
                        });
                }

                setSyncStatus('synced');
                showToast('åŒæ­¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                setSyncStatus('error');
                showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // è·å–å½“å‰æ­¥éª¤
        function getCurrentStep() {
            if (top3Goals.length === 3 && weights.reduce((a, b) => a + b, 0) === 100) return 5;
            if (top3Goals.length === 3) return 4;
            if (top5Goals.length === 5) return 3;
            if (top5Goals.length > 0) return 2;
            return allGoalsList.length > 0 ? 1 : 0;
        }

        // è®¾ç½®åŒæ­¥çŠ¶æ€
        function setSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');

            syncStatus.classList.remove('synced', 'syncing', 'error');

            switch (status) {
                case 'synced':
                    syncStatus.classList.add('synced');
                    syncText.textContent = 'å·²åŒæ­¥';
                    break;
                case 'syncing':
                    syncStatus.classList.add('syncing');
                    syncText.textContent = 'åŒæ­¥ä¸­...';
                    break;
                case 'error':
                    syncText.textContent = 'åŒæ­¥å¤±è´¥';
                    break;
                default:
                    syncText.textContent = isCloudMode ? 'å·²ç™»å½•' : 'æœ¬åœ°æ¨¡å¼';
            }
        }

        // é‡å†™ saveToStorage ä»¥æ”¯æŒäº‘ç«¯åŒæ­¥
        const originalSaveToStorage = saveToStorage;
        saveToStorage = async function(step) {
            // ä¿å­˜åˆ°æœ¬åœ°
            originalSaveToStorage(step);

            // å¦‚æœå·²ç™»å½•ï¼Œä¿å­˜åˆ°äº‘ç«¯
            if (isCloudMode && currentUser) {
                saveToCloud(step);
            }
        };

        // é¡µé¢åŠ è½½
        window.onload = async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');

            // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
            const textarea = document.getElementById('allGoals');
            if (textarea) {
                console.log('æ‰¾åˆ°è¾“å…¥æ¡†ï¼Œç»‘å®šé”®ç›˜äº‹ä»¶');
                textarea.addEventListener('keydown', handleInputKeydown);
            } else {
                console.error('æ‰¾ä¸åˆ°è¾“å…¥æ¡† allGoals');
            }

            await checkAuth();
        };
    </script>
</body>
</html>
