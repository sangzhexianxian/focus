<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026ä¸“æ³¨ - åå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h1 {
            font-size: 28px;
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-box .subtitle {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .login-box .logo {
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ä¸»é¡µé¢æ ·å¼ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-left p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .change {
            font-size: 13px;
            margin-top: 5px;
        }

        .stat-card .change.positive {
            color: #28a745;
        }

        .stat-card .change.negative {
            color: #dc3545;
        }

        .chart-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .chart-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-section .export-btn {
            padding: 6px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .data-table {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .data-table h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 13px;
            color: #666;
        }

        td {
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .container {
                padding: 0 15px;
            }

            .data-table {
                overflow-x: auto;
            }

            .header {
                padding: 15px 20px;
            }

            .header-left h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="logo">ğŸ”</div>
            <h1>åå°ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="subtitle">2026ä¸“æ³¨ - å•†ç”¨ç‰ˆ</p>
            <div class="error-message" id="loginError"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>ç®¡ç†å‘˜è´¦å·</label>
                    <input type="email" id="adminEmail" placeholder="admin@yourdomain.com" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">ç™»å½•</button>
            </form>
            <p style="text-align: center; margin-top: 20px; font-size: 13px; color: #999;">
                ç™»å½•å³è¡¨ç¤ºåŒæ„ã€Šç®¡ç†åå°ä½¿ç”¨åè®®ã€‹
            </p>
        </div>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="mainPage" class="hidden">
        <div class="header">
            <div class="header-left">
                <h1>ğŸ“Š 2026ä¸“æ³¨ - åå°ç®¡ç†ç³»ç»Ÿ</h1>
                <p>æ•°æ®æ¦‚è§ˆä¸ç”¨æˆ·ç®¡ç†</p>
            </div>
            <div class="header-right">
                <span class="admin-info" id="adminInfo"></span>
                <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="container">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ€»ç”¨æˆ·æ•°</h3>
                    <div class="value" id="totalUsers">-</div>
                    <div class="change" id="usersChange">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>æ´»è·ƒç”¨æˆ·ï¼ˆ7å¤©ï¼‰</h3>
                    <div class="value" id="activeUsers">-</div>
                    <div class="change" id="activeChange">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>å®Œæˆç›®æ ‡ç”¨æˆ·</h3>
                    <div class="value" id="completedUsers">-</div>
                    <div class="change positive" id="completedChange">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡å®Œæˆæ—¶é—´</h3>
                    <div class="value" id="avgTime">-</div>
                    <div class="change" id="timeChange">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>ä»Šæ—¥æ–°å¢</h3>
                    <div class="value" id="todayNew">-</div>
                    <div class="change positive" id="todayChange">åŠ è½½ä¸­...</div>
                </div>
                <div class="stat-card">
                    <h3>è½¬åŒ–ç‡</h3>
                    <div class="value" id="conversionRate">-</div>
                    <div class="change" id="conversionChange">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="chart-section">
                <h2>
                    ğŸ“ˆ ç”¨æˆ·å¢é•¿è¶‹åŠ¿
                    <button class="export-btn" onclick="exportData('growth')">å¯¼å‡ºæ•°æ®</button>
                </h2>
                <canvas id="userGrowthChart" height="300"></canvas>
            </div>

            <div class="chart-section">
                <h2>
                    ğŸ¯ ç›®æ ‡å®Œæˆæƒ…å†µ
                    <button class="export-btn" onclick="exportData('completion')">å¯¼å‡ºæ•°æ®</button>
                </h2>
                <canvas id="goalCompletionChart" height="300"></canvas>
            </div>

            <!-- ç”¨æˆ·æ•°æ®è¡¨æ ¼ -->
            <div class="data-table">
                <h2>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</h2>
                <div class="filter-bar">
                    <input type="text" id="searchUser" placeholder="æœç´¢ç”¨æˆ· ID...">
                    <select id="statusFilter">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">å·²å®Œæˆ</option>
                        <option value="incomplete">è¿›è¡Œä¸­</option>
                        <option value="inactive">æœªå¼€å§‹</option>
                    </select>
                    <select id="timeFilter">
                        <option value="all">å…¨éƒ¨æ—¶é—´</option>
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ€è¿‘7å¤©</option>
                        <option value="month">æœ€è¿‘30å¤©</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadUsers()">åˆ·æ–°æ•°æ®</button>
                    <button class="btn btn-success" onclick="exportUserData()">å¯¼å‡ºå…¨éƒ¨</button>
                </div>
                <div id="usersContainer">
                    <div class="loading">åŠ è½½æ•°æ®ä¸­...</div>
                </div>
            </div>

            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="data-table">
                <h2>âš™ï¸ ç³»ç»Ÿä¿¡æ¯</h2>
                <table>
                    <tr>
                        <th>ç³»ç»Ÿç‰ˆæœ¬</th>
                        <td>2026ä¸“æ³¨ v1.0.0 (å•†ç”¨ç‰ˆ)</td>
                    </tr>
                    <tr>
                        <th>æ•°æ®åº“çŠ¶æ€</th>
                        <td id="dbStatus">æ£€æµ‹ä¸­...</td>
                    </tr>
                    <tr>
                        <th>æœ€åæ›´æ–°</th>
                        <td id="lastUpdate">-</td>
                    </tr>
                    <tr>
                        <th>æ•°æ®æ€»å¤§å°</th>
                        <td id="dataSize">è®¡ç®—ä¸­...</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const CONFIG = {
            // Supabase é…ç½®
            SUPABASE_URL: 'https://klywwizwconvwjifzrcw.supabase.co',
            SUPABASE_KEY: 'sb_publishable_65tNpTMzDgY8PFEQxIS-Eg_0tXESrkV',
            
            // ç®¡ç†å‘˜é‚®ç®±åˆ—è¡¨ï¼ˆå•†ç”¨éƒ¨ç½²æ—¶è¯·ä¿®æ”¹ï¼‰
            ADMIN_EMAILS: [
                'admin@focus2026.com',
                'admin@yourdomain.com'
            ],
            
            // ä¼šè¯è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            SESSION_TIMEOUT: 2 * 60 * 60 * 1000 // 2å°æ—¶
        };

        // å…¨å±€å˜é‡
        let supabase = null;
        let currentAdmin = null;
        let sessionExpiry = null;
        let allUsers = [];
        let userGrowthChart = null;
        let goalCompletionChart = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            initSupabase();
            checkSession();
        };

        // åˆå§‹åŒ– Supabase
        function initSupabase() {
            try {
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
                    console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
                }
            } catch (e) {
                console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', e);
            }
        }

        // æ£€æŸ¥ä¼šè¯
        function checkSession() {
            const session = localStorage.getItem('admin_session');
            if (session) {
                const data = JSON.parse(session);
                const now = Date.now();
                
                // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                if (now < data.expiry) {
                    currentAdmin = data.admin;
                    sessionExpiry = data.expiry;
                    showMainPage();
                    return;
                } else {
                    localStorage.removeItem('admin_session');
                }
            }
            showLoginPage();
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
        }

        // æ˜¾ç¤ºä¸»é¡µé¢
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('adminInfo').textContent = `ç®¡ç†å‘˜: ${currentAdmin.email}`;
            
            // è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
            startAutoRefresh();
            
            // åŠ è½½æ•°æ®
            loadAllData();
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('loginError');
            
            // éªŒè¯é‚®ç®±
            if (!CONFIG.ADMIN_EMAILS.includes(email)) {
                showError('è´¦å·ä¸å­˜åœ¨æˆ–æ— æƒé™');
                return;
            }
            
            // ç®€å•å¯†ç éªŒè¯ï¼ˆå•†ç”¨éƒ¨ç½²æ—¶å»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ¡ˆï¼‰
            // è¿™é‡Œä½¿ç”¨æ¼”ç¤ºå¯†ç ï¼Œå®é™…åº”è¯¥ä½¿ç”¨ Supabase Auth æˆ–åç«¯ API
            const DEMO_PASSWORD = 'Admin@2026';
            
            if (password !== DEMO_PASSWORD) {
                showError('å¯†ç é”™è¯¯');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';
            errorMsg.classList.remove('show');
            
            try {
                // åˆ›å»ºä¼šè¯
                currentAdmin = {
                    email: email,
                    loginTime: Date.now()
                };
                
                sessionExpiry = Date.now() + CONFIG.SESSION_TIMEOUT;
                
                const session = {
                    admin: currentAdmin,
                    expiry: sessionExpiry
                };
                
                localStorage.setItem('admin_session', JSON.stringify(session));
                
                // ç™»å½•æˆåŠŸ
                showMainPage();
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showError('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å½•';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorMsg = document.getElementById('loginError');
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
        }

        // é€€å‡ºç™»å½•
        function handleLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('admin_session');
                currentAdmin = null;
                sessionExpiry = null;
                
                if (userGrowthChart) userGrowthChart.destroy();
                if (goalCompletionChart) goalCompletionChart.destroy();
                
                showLoginPage();
                document.getElementById('loginForm').reset();
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loginBtn').textContent = 'ç™»å½•';
            }
        }

        // è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        let autoRefreshTimer = null;
        function startAutoRefresh() {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(() => {
                if (currentAdmin && document.getElementById('mainPage').classList.contains('hidden') === false) {
                    loadAllData();
                }
            }, 5 * 60 * 1000); // 5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            try {
                await loadStats();
                await loadUsers();
                await renderCharts();
                await loadSystemInfo();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const { data: usersData, error: usersError } = await supabase
                    .from('user_focus_data')
                    .select('*');

                if (usersError) throw usersError;

                const total = usersData.length;
                const completed = usersData.filter(u => {
                    try {
                        const data = JSON.parse(u.focus_data);
                        return data.step >= 5;
                    } catch { return false; }
                }).length;

                const active = usersData.filter(u => {
                    try {
                        const data = JSON.parse(u.focus_data);
                        return data.step > 0 && data.step < 5;
                    } catch { return false; }
                }).length;

                // ä»Šæ—¥æ–°å¢
                const today = new Date().toISOString().split('T')[0];
                const todayNew = usersData.filter(u => u.created_at.startsWith(today)).length;

                // è®¡ç®—å¹³å‡å®Œæˆæ—¶é—´
                let totalTime = 0;
                let count = 0;
                usersData.forEach(u => {
                    if (u.created_at && u.updated_at && u.created_at !== u.updated_at) {
                        const diff = new Date(u.updated_at) - new Date(u.created_at);
                        totalTime += diff;
                        count++;
                    }
                });
                const avgTime = count > 0 ? Math.round(totalTime / count / 1000 / 60) : 0;

                // è½¬åŒ–ç‡ï¼ˆå®Œæˆç”¨æˆ· / æ€»ç”¨æˆ·ï¼‰
                const conversionRate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('totalUsers').textContent = total;
                document.getElementById('activeUsers').textContent = active;
                document.getElementById('completedUsers').textContent = completed;
                document.getElementById('avgTime').textContent = avgTime + ' åˆ†é’Ÿ';
                document.getElementById('todayNew').textContent = todayNew;
                document.getElementById('conversionRate').textContent = conversionRate + '%';

                document.getElementById('usersChange').textContent = `æ´»è·ƒ: ${active}`;
                document.getElementById('activeChange').textContent = '7å¤©å†…æ´»è·ƒ';
                document.getElementById('completedChange').textContent = 'å·²å®Œæˆæ‰€æœ‰æ­¥éª¤';
                document.getElementById('timeChange').textContent = 'å¹³å‡ç”¨æ—¶';
                document.getElementById('todayChange').textContent = 'ä»Šæ—¥æ–°å¢ç”¨æˆ·';
                document.getElementById('conversionChange').textContent = 'å®Œæˆç‡';

                allUsers = usersData;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            const container = document.getElementById('usersContainer');

            try {
                const searchTerm = document.getElementById('searchUser').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const timeFilter = document.getElementById('timeFilter').value;

                let filteredUsers = allUsers.filter(u => {
                    // çŠ¶æ€è¿‡æ»¤
                    let status = 'inactive';
                    try {
                        const data = JSON.parse(u.focus_data);
                        if (data.step >= 5) status = 'active';
                        else if (data.step > 0) status = 'incomplete';
                    } catch {}
                    
                    if (statusFilter !== 'all' && status !== statusFilter) return false;

                    // æ—¶é—´è¿‡æ»¤
                    const userDate = new Date(u.created_at);
                    const now = new Date();
                    const daysDiff = (now - userDate) / (1000 * 60 * 60 * 24);

                    if (timeFilter === 'today' && daysDiff >= 1) return false;
                    if (timeFilter === 'week' && daysDiff >= 7) return false;
                    if (timeFilter === 'month' && daysDiff >= 30) return false;

                    // æœç´¢è¿‡æ»¤
                    if (searchTerm && !u.user_id.toLowerCase().includes(searchTerm)) return false;

                    return true;
                });

                if (filteredUsers.length === 0) {
                    container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                    return;
                }

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ· ID</th>
                                <th>å½“å‰æ­¥éª¤</th>
                                <th>ç›®æ ‡æ•°é‡</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ›´æ–°æ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                filteredUsers.forEach(user => {
                    let step = 0;
                    let goalCount = 0;
                    try {
                        const data = JSON.parse(user.focus_data);
                        step = data.step || 0;
                        goalCount = (data.allGoalsList || []).length;
                    } catch {}

                    const stepNames = ['æœªå¼€å§‹', 'è¾“å…¥ç›®æ ‡', 'é€‰æ‹©5ä¸ª', 'é€‰æ‹©3ä¸ª', 'åˆ†é…æƒé‡', 'å®Œæˆ'];
                    const status = step >= 5 ? 'active' : (step > 0 ? 'incomplete' : 'inactive');
                    const statusText = step >= 5 ? 'å·²å®Œæˆ' : (step > 0 ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹');

                    html += `
                        <tr>
                            <td title="${user.user_id}">${user.user_id.substring(0, 16)}...</td>
                            <td>${stepNames[Math.min(step, 5)]}</td>
                            <td>${goalCount}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>${formatDate(user.updated_at)}</td>
                            <td><span class="status-badge ${status}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-primary" style="padding: 4px 10px; font-size: 12px;" onclick="viewUserDetail('${user.id}')">æŸ¥çœ‹</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');

            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“å›¾è¡¨
        async function renderCharts() {
            await renderUserGrowthChart();
            await renderGoalCompletionChart();
        }

        // ç”¨æˆ·å¢é•¿å›¾è¡¨
        async function renderUserGrowthChart() {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');

            const userDates = allUsers.map(u => u.created_at.split('T')[0]);
            const dateCount = {};
            userDates.forEach(date => {
                dateCount[date] = (dateCount[date] || 0) + 1;
            });

            const sortedDates = Object.keys(dateCount).sort();
            const recentDates = sortedDates.slice(-30);
            const values = recentDates.map(d => dateCount[d]);

            if (userGrowthChart) userGrowthChart.destroy();

            userGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentDates.map(d => d.substring(5)),
                    datasets: [{
                        label: 'æ–°å¢ç”¨æˆ·',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // ç›®æ ‡å®Œæˆå›¾è¡¨
        async function renderGoalCompletionChart() {
            const ctx = document.getElementById('goalCompletionChart').getContext('2d');

            let stepCounts = [0, 0, 0, 0, 0, 0];
            allUsers.forEach(u => {
                try {
                    const data = JSON.parse(u.focus_data);
                    const step = Math.min(data.step || 0, 5);
                    stepCounts[step]++;
                } catch {}
            });

            if (goalCompletionChart) goalCompletionChart.destroy();

            goalCompletionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æœªå¼€å§‹', 'è¾“å…¥ç›®æ ‡', 'é€‰æ‹©5ä¸ª', 'é€‰æ‹©3ä¸ª', 'åˆ†é…æƒé‡', 'å®Œæˆ'],
                    datasets: [{
                        label: 'ç”¨æˆ·æ•°é‡',
                        data: stepCounts,
                        backgroundColor: [
                            '#e0e0e0',
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#ffc107',
                            '#28a745'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        async function loadSystemInfo() {
            try {
                // æ•°æ®åº“çŠ¶æ€
                document.getElementById('dbStatus').innerHTML = '<span style="color: #28a745;">âœ“ æ­£å¸¸</span>';

                // è®¡ç®—æ•°æ®å¤§å°
                let totalSize = 0;
                allUsers.forEach(u => {
                    totalSize += u.focus_data.length;
                });
                const sizeKB = (totalSize / 1024).toFixed(2);
                document.getElementById('dataSize').textContent = sizeKB + ' KB';

            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('dbStatus').innerHTML = '<span style="color: #dc3545;">âœ— å¼‚å¸¸</span>';
            }
        }

        // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
        function viewUserDetail(userId) {
            alert('ç”¨æˆ·è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...\nç”¨æˆ· ID: ' + userId);
        }

        // å¯¼å‡ºæ•°æ®
        function exportData(type) {
            if (type === 'growth') {
                // å¯¼å‡ºå¢é•¿æ•°æ®
                const userDates = allUsers.map(u => u.created_at.split('T')[0]);
                const dateCount = {};
                userDates.forEach(date => {
                    dateCount[date] = (dateCount[date] || 0) + 1;
                });

                const csv = 'æ—¥æœŸ,æ–°å¢ç”¨æˆ·\n' + Object.entries(dateCount)
                    .map(([date, count]) => `${date},${count}`)
                    .join('\n');

                downloadCSV(csv, 'ç”¨æˆ·å¢é•¿æ•°æ®.csv');
            } else if (type === 'completion') {
                // å¯¼å‡ºå®Œæˆæ•°æ®
                let stepCounts = [0, 0, 0, 0, 0, 0];
                allUsers.forEach(u => {
                    try {
                        const data = JSON.parse(u.focus_data);
                        const step = Math.min(data.step || 0, 5);
                        stepCounts[step]++;
                    } catch {}
                });

                const csv = 'æ­¥éª¤,ç”¨æˆ·æ•°\n' + [
                    'æœªå¼€å§‹,0',
                    'è¾“å…¥ç›®æ ‡,1',
                    'é€‰æ‹©5ä¸ª,2',
                    'é€‰æ‹©3ä¸ª,3',
                    'åˆ†é…æƒé‡,4',
                    'å®Œæˆ,5'
                ].map((line, i) => `${line.split(',')[0]},${stepCounts[i]}`)
                    .join('\n');

                downloadCSV(csv, 'ç›®æ ‡å®Œæˆæ•°æ®.csv');
            }
        }

        // å¯¼å‡ºç”¨æˆ·æ•°æ®
        function exportUserData() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            let filteredUsers = allUsers.filter(u => {
                let status = 'inactive';
                try {
                    const data = JSON.parse(u.focus_data);
                    if (data.step >= 5) status = 'active';
                    else if (data.step > 0) status = 'incomplete';
                } catch {}

                if (statusFilter !== 'all' && status !== statusFilter) return false;
                if (searchTerm && !u.user_id.toLowerCase().includes(searchTerm)) return false;

                return true;
            });

            const csv = 'ç”¨æˆ·ID,å½“å‰æ­¥éª¤,ç›®æ ‡æ•°é‡,åˆ›å»ºæ—¶é—´,æ›´æ–°æ—¶é—´\n' +
                filteredUsers.map(u => {
                    let step = 0;
                    let goalCount = 0;
                    try {
                        const data = JSON.parse(u.focus_data);
                        step = data.step || 0;
                        goalCount = (data.allGoalsList || []).length;
                    } catch {}

                    return `${u.user_id},${step},${goalCount},${u.created_at},${u.updated_at}`;
                }).join('\n');

            downloadCSV(csv, 'ç”¨æˆ·æ•°æ®.csv');
        }

        // ä¸‹è½½CSV
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
