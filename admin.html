<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026ä¸“æ³¨ - åå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .change {
            font-size: 13px;
            margin-top: 5px;
        }

        .stat-card .change.positive {
            color: #28a745;
        }

        .stat-card .change.negative {
            color: #dc3545;
        }

        .chart-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .chart-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        .data-table {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .data-table h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 13px;
            color: #666;
        }

        td {
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .container {
                padding: 0 15px;
            }

            .data-table {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š 2026ä¸“æ³¨ - åå°ç®¡ç†ç³»ç»Ÿ</h1>
        <p>æ•°æ®æ¦‚è§ˆä¸ç”¨æˆ·ç®¡ç†</p>
    </div>

    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>æ€»ç”¨æˆ·æ•°</h3>
                <div class="value" id="totalUsers">-</div>
                <div class="change" id="usersChange">åŠ è½½ä¸­...</div>
            </div>
            <div class="stat-card">
                <h3>æ´»è·ƒç”¨æˆ·ï¼ˆ7å¤©ï¼‰</h3>
                <div class="value" id="activeUsers">-</div>
                <div class="change" id="activeChange">åŠ è½½ä¸­...</div>
            </div>
            <div class="stat-card">
                <h3>å®Œæˆç›®æ ‡ç”¨æˆ·</h3>
                <div class="value" id="completedUsers">-</div>
                <div class="change positive" id="completedChange">åŠ è½½ä¸­...</div>
            </div>
            <div class="stat-card">
                <h3>å¹³å‡å®Œæˆæ—¶é—´</h3>
                <div class="value" id="avgTime">-</div>
                <div class="change" id="timeChange">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="chart-section">
            <h2>ğŸ“ˆ ç”¨æˆ·å¢é•¿è¶‹åŠ¿</h2>
            <canvas id="userGrowthChart" height="300"></canvas>
        </div>

        <div class="chart-section">
            <h2>ğŸ¯ ç›®æ ‡å®Œæˆæƒ…å†µ</h2>
            <canvas id="goalCompletionChart" height="300"></canvas>
        </div>

        <!-- ç”¨æˆ·æ•°æ®è¡¨æ ¼ -->
        <div class="data-table">
            <h2>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</h2>
            <div class="filter-bar">
                <input type="text" id="searchUser" placeholder="æœç´¢ç”¨æˆ·é‚®ç®±...">
                <select id="statusFilter">
                    <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="active">å·²å®Œæˆ</option>
                    <option value="incomplete">è¿›è¡Œä¸­</option>
                </select>
                <button class="btn btn-primary" onclick="loadUsers()">åˆ·æ–°æ•°æ®</button>
            </div>
            <div id="usersContainer">
                <div class="loading">åŠ è½½æ•°æ®ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://klywwizwconvwjifzrcw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_65tNpTMzDgY8PFEQxIS-Eg_0tXESrkV';

        // åˆå§‹åŒ– Supabase
        let supabase = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
            }
        } catch (e) {
            console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', e);
        }

        // å­˜å‚¨æ•°æ®
        let allUsers = [];

        // é¡µé¢åŠ è½½
        window.onload = async function() {
            if (!supabase) {
                alert('äº‘æœåŠ¡æœªåˆå§‹åŒ–');
                return;
            }

            await loadAllData();
        };

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            try {
                await loadStats();
                await loadUsers();
                await renderCharts();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                // è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
                const { data: usersData, error: usersError } = await supabase
                    .from('user_focus_data')
                    .select('*');

                if (usersError) throw usersError;

                const total = usersData.length;
                const completed = usersData.filter(u => {
                    try {
                        const data = JSON.parse(u.focus_data);
                        return data.step >= 5;
                    } catch {
                        return false;
                    }
                }).length;

                const active = usersData.filter(u => {
                    try {
                        const data = JSON.parse(u.focus_data);
                        return data.step > 0 && data.step < 5;
                    } catch {
                        return false;
                    }
                }).length;

                // è®¡ç®—å¹³å‡å®Œæˆæ—¶é—´ï¼ˆåŸºäºåˆ›å»ºæ—¶é—´åˆ°æœ€è¿‘æ›´æ–°æ—¶é—´ï¼‰
                let totalTime = 0;
                let count = 0;
                usersData.forEach(u => {
                    if (u.created_at && u.updated_at && u.created_at !== u.updated_at) {
                        const diff = new Date(u.updated_at) - new Date(u.created_at);
                        totalTime += diff;
                        count++;
                    }
                });
                const avgTime = count > 0 ? Math.round(totalTime / count / 1000 / 60) : 0; // åˆ†é’Ÿ

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('totalUsers').textContent = total;
                document.getElementById('activeUsers').textContent = active;
                document.getElementById('completedUsers').textContent = completed;
                document.getElementById('avgTime').textContent = avgTime + ' åˆ†é’Ÿ';

                document.getElementById('usersChange').textContent = 'æ€»æ³¨å†Œç”¨æˆ·';
                document.getElementById('activeChange').textContent = '7å¤©å†…æ´»è·ƒ';
                document.getElementById('completedChange').textContent = 'å·²å®Œæˆæ‰€æœ‰æ­¥éª¤';
                document.getElementById('timeChange').textContent = 'å¹³å‡ç”¨æ—¶';

                allUsers = usersData;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            const container = document.getElementById('usersContainer');

            try {
                const searchTerm = document.getElementById('searchUser').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;

                let filteredUsers = allUsers.filter(u => {
                    // çŠ¶æ€è¿‡æ»¤
                    let status = 'incomplete';
                    try {
                        const data = JSON.parse(u.focus_data);
                        if (data.step >= 5) status = 'active';
                    } catch {}
                    
                    if (statusFilter !== 'all' && status !== statusFilter) return false;

                    // æœç´¢è¿‡æ»¤
                    if (searchTerm && !u.user_id.toLowerCase().includes(searchTerm)) return false;

                    return true;
                });

                if (filteredUsers.length === 0) {
                    container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                    return;
                }

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ· ID</th>
                                <th>å½“å‰æ­¥éª¤</th>
                                <th>ç›®æ ‡æ•°é‡</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ›´æ–°æ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                filteredUsers.forEach(user => {
                    let step = 0;
                    let goalCount = 0;
                    try {
                        const data = JSON.parse(user.focus_data);
                        step = data.step || 0;
                        goalCount = (data.allGoalsList || []).length;
                    } catch {}

                    const stepNames = ['æœªå¼€å§‹', 'è¾“å…¥ç›®æ ‡', 'é€‰æ‹©5ä¸ª', 'é€‰æ‹©3ä¸ª', 'åˆ†é…æƒé‡', 'å®Œæˆ'];
                    const status = step >= 5 ? 'active' : 'incomplete';

                    html += `
                        <tr>
                            <td>${user.user_id.substring(0, 16)}...</td>
                            <td>${stepNames[Math.min(step, 5)]}</td>
                            <td>${goalCount}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>${formatDate(user.updated_at)}</td>
                            <td><span class="status-badge ${status}">${step >= 5 ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</span></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“å›¾è¡¨
        async function renderCharts() {
            await renderUserGrowthChart();
            await renderGoalCompletionChart();
        }

        // ç”¨æˆ·å¢é•¿å›¾è¡¨
        async function renderUserGrowthChart() {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');

            // æŒ‰æ—¥æœŸç»Ÿè®¡ç”¨æˆ·
            const userDates = allUsers.map(u => u.created_at.split('T')[0]);
            const dateCount = {};
            userDates.forEach(date => {
                dateCount[date] = (dateCount[date] || 0) + 1;
            });

            // æ’åºå¹¶è·å–æœ€è¿‘30å¤©
            const sortedDates = Object.keys(dateCount).sort();
            const recentDates = sortedDates.slice(-30);
            const values = recentDates.map(d => dateCount[d]);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentDates.map(d => d.substring(5)), // åªæ˜¾ç¤º æœˆ-æ—¥
                    datasets: [{
                        label: 'æ–°å¢ç”¨æˆ·',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ç›®æ ‡å®Œæˆå›¾è¡¨
        async function renderGoalCompletionChart() {
            const ctx = document.getElementById('goalCompletionChart').getContext('2d');

            let stepCounts = [0, 0, 0, 0, 0, 0];
            allUsers.forEach(u => {
                try {
                    const data = JSON.parse(u.focus_data);
                    const step = Math.min(data.step || 0, 5);
                    stepCounts[step]++;
                } catch {}
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æœªå¼€å§‹', 'è¾“å…¥ç›®æ ‡', 'é€‰æ‹©5ä¸ª', 'é€‰æ‹©3ä¸ª', 'åˆ†é…æƒé‡', 'å®Œæˆ'],
                    datasets: [{
                        label: 'ç”¨æˆ·æ•°é‡',
                        data: stepCounts,
                        backgroundColor: [
                            '#e0e0e0',
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#ffc107',
                            '#28a745'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
